{"version":3,"sources":["../../../src/common/utils/pricing-lookup.service.ts"],"sourcesContent":["import { Injectable } from '@nestjs/common';\nimport { PrismaService } from '../../prisma/prisma.service';\n\n/**\n * Pricing Lookup Service\n * Provides VLOOKUP-like functionality for pricing data from database\n * Replaces Excel lookup tables (W:Z, W:Y ranges)\n */\n@Injectable()\nexport class PricingLookupService {\n  constructor(private readonly prisma: PrismaService) {}\n\n  /**\n   * Lookup material by code\n   * Replaces: VLOOKUP in Material sheet (W:Z range)\n   */\n  async getMaterialByCode(code: string) {\n    return this.prisma.material.findUnique({\n      where: { code, isActive: true },\n    });\n  }\n\n  /**\n   * Lookup material by name/description (handles Persian names)\n   * Matches Persian material names from CSV to pricing table\n   */\n  async getMaterialByName(name: string) {\n    if (!name) return undefined;\n    \n    const normalizedName = name.trim().toLowerCase();\n    \n    // Try exact match first on description or code\n    let material = await this.prisma.material.findFirst({\n      where: {\n        OR: [\n          { description: { contains: normalizedName, mode: 'insensitive' } },\n          { code: { equals: normalizedName, mode: 'insensitive' } },\n        ],\n        isActive: true,\n      },\n    });\n    \n    if (material) return material;\n    \n    // Check persianNames array\n    const materials = await this.prisma.material.findMany({\n      where: { isActive: true },\n    });\n    \n    for (const m of materials) {\n      if (m.persianNames.some((pn: string) => \n        normalizedName.includes(pn.toLowerCase()) || \n        pn.toLowerCase().includes(normalizedName)\n      )) {\n        return m;\n      }\n    }\n    \n    // Fallback: return first MDF material or first material\n    const fallback = await this.prisma.material.findFirst({\n      where: {\n        OR: [\n          { description: { contains: 'mdf', mode: 'insensitive' } },\n          { description: { contains: 'ام', mode: 'insensitive' } },\n        ],\n        isActive: true,\n      },\n    });\n    \n    return fallback || materials[0];\n  }\n\n  /**\n   * Get all active materials\n   */\n  async getAllMaterials() {\n    return this.prisma.material.findMany({\n      where: { isActive: true },\n      orderBy: { description: 'asc' },\n    });\n  }\n\n  /**\n   * Lookup edge banding by code\n   * Replaces: VLOOKUP in BoreshKari sheet (W:Y range)\n   */\n  async getEdgeBandingByCode(code: string) {\n    return this.prisma.edgeBanding.findUnique({\n      where: { code, isActive: true },\n    });\n  }\n\n  /**\n   * Get all active edge banding options\n   */\n  async getAllEdgeBanding() {\n    return this.prisma.edgeBanding.findMany({\n      where: { isActive: true },\n      orderBy: { description: 'asc' },\n    });\n  }\n\n  /**\n   * Lookup CNC operation by code\n   */\n  async getCNCOperationByCode(code: string) {\n    return this.prisma.cNCOperation.findUnique({\n      where: { code, isActive: true },\n    });\n  }\n\n  /**\n   * Get all active CNC operations\n   */\n  async getAllCNCOperations() {\n    return this.prisma.cNCOperation.findMany({\n      where: { isActive: true },\n      orderBy: { description: 'asc' },\n    });\n  }\n\n  /**\n   * Lookup cutting operation by code\n   */\n  async getCuttingByCode(code: string) {\n    // For now, using CNC operations for cutting\n    return this.getCNCOperationByCode(code);\n  }\n\n  /**\n   * Lookup fitting by code\n   * Replaces: VLOOKUP in Fittings sheet (W:X range)\n   */\n  async getFittingByCode(code: string) {\n    return this.prisma.fitting.findUnique({\n      where: { code, isActive: true },\n    });\n  }\n\n  /**\n   * Get all active fittings\n   */\n  async getAllFittings() {\n    return this.prisma.fitting.findMany({\n      where: { isActive: true },\n      orderBy: { name: 'asc' },\n    });\n  }\n\n  /**\n   * Lookup fitting by name (handles Persian names)\n   * Matches Persian fitting names from components to pricing table\n   */\n  async getFittingByName(name: string) {\n    if (!name) return undefined;\n    \n    const normalizedName = name.trim().toLowerCase();\n    \n    // Try exact match first on name or code\n    const fitting = await this.prisma.fitting.findFirst({\n      where: {\n        OR: [\n          { name: { contains: normalizedName, mode: 'insensitive' } },\n          { code: { equals: normalizedName, mode: 'insensitive' } },\n        ],\n        isActive: true,\n      },\n    });\n    \n    return fitting;\n  }\n\n  /**\n   * Get color by code (placeholder - colors can be added to DB later)\n   */\n  getColorByCode(code: string): string | undefined {\n    const colorMap: Record<string, string> = {\n      COL001: 'White',\n      COL002: 'Black',\n      COL003: 'Oak',\n      COL004: 'Walnut',\n    };\n    return colorMap[code];\n  }\n\n  /**\n   * Search materials by description\n   */\n  async searchMaterials(query: string) {\n    return this.prisma.material.findMany({\n      where: {\n        description: { contains: query, mode: 'insensitive' },\n        isActive: true,\n      },\n      orderBy: { description: 'asc' },\n    });\n  }\n\n  /**\n   * Get materials by category\n   */\n  async getMaterialsByCategory(category: string) {\n    return this.prisma.material.findMany({\n      where: {\n        category,\n        isActive: true,\n      },\n      orderBy: { description: 'asc' },\n    });\n  }\n}\n"],"names":["PricingLookupService","getMaterialByCode","code","prisma","material","findUnique","where","isActive","getMaterialByName","name","undefined","normalizedName","trim","toLowerCase","findFirst","OR","description","contains","mode","equals","materials","findMany","m","persianNames","some","pn","includes","fallback","getAllMaterials","orderBy","getEdgeBandingByCode","edgeBanding","getAllEdgeBanding","getCNCOperationByCode","cNCOperation","getAllCNCOperations","getCuttingByCode","getFittingByCode","fitting","getAllFittings","getFittingByName","getColorByCode","colorMap","COL001","COL002","COL003","COL004","searchMaterials","query","getMaterialsByCategory","category"],"mappings":"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"}