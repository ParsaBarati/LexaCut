{"version":3,"sources":["../../../src/modules/pricing/pricing.service.ts"],"sourcesContent":["import { Injectable } from '@nestjs/common';\nimport {\n  CostBreakdown,\n  FinancialSummary,\n  PricingConfig,\n} from '../../common/interfaces';\nimport { sum } from '../../common/utils/excel-functions';\nimport { PrismaService } from '../../prisma/prisma.service';\n\n/**\n * Pricing Service\n * Implements the core pricing calculations from \"روکش مالی\" (Financial Summary) sheet\n * This is the heart of the cost calculation engine\n */\n@Injectable()\nexport class PricingService {\n  /**\n   * Default pricing configuration matching Excel defaults\n   * From \"روکش مالی\" sheet cells A27-A31\n   */\n  private defaultConfig: PricingConfig = {\n    overhead1: 0.25,      // روکش مالی!A27 = SUM(A7:A26) * 0.25\n    overhead2: 0.04,      // روکش مالی!A28 = SUM(A7:A26) * 0.04\n    overhead3: 0.02,      // روکش مالی!A29 = SUM(A7:A26) * 0.02\n    overhead4: 0.02,      // روکش مالی!A30 = SUM(A7:A26) * 0.02\n    contingency: 0.025,   // روکش مالی!A31 = SUM(A7:A26) * 0.025\n    profitMargin: 0.22,   // روکش مالی!A33 = A32 + (A32 * 0.22)\n  };\n\n  constructor(private readonly prisma: PrismaService) {}\n\n  /**\n   * Get active pricing configuration from database\n   */\n  async getActiveConfig(): Promise<PricingConfig> {\n    const dbConfig = await this.prisma.pricingConfig.findFirst({\n      where: { isActive: true },\n      orderBy: { createdAt: 'desc' },\n    });\n\n    if (dbConfig) {\n      return {\n        overhead1: dbConfig.overhead1,\n        overhead2: dbConfig.overhead2,\n        overhead3: dbConfig.overhead3,\n        overhead4: dbConfig.overhead4,\n        contingency: dbConfig.contingency,\n        profitMargin: dbConfig.profitMargin,\n      };\n    }\n\n    return this.defaultConfig;\n  }\n\n  /**\n   * Calculate complete financial summary with overheads and profit\n   * Exactly matches Excel \"روکش مالی\" sheet calculations\n   * \n   * @param costs - Complete cost breakdown from all categories\n   * @param config - Optional custom pricing configuration\n   * @returns Complete financial summary with final price\n   */\n  async calculateFinancialSummary(\n    costs: CostBreakdown,\n    config?: Partial<PricingConfig>\n  ): Promise<FinancialSummary> {\n    // Load config from database if not provided\n    const activeConfig = await this.getActiveConfig();\n    const pricingConfig = { ...activeConfig, ...config };\n\n    // Extract individual category costs\n    // Maps to روکش مالی sheet cells A7-A14\n    const breakdown = {\n      material: costs.material.totalCost,           // روکش مالی!A7 = Material!A31\n      boreshKari: costs.boreshKari.totalCost,       // روکش مالی!A8 = BoreshKari!A31\n      navarShiar: costs.navarShiar.totalCost,       // روکش مالی!A9 = NavarShiarFarsi!A31\n      cnc: costs.cnc.totalCost,                     // روکش مالی!A10 = CNC!A31\n      fittings: costs.fittings.totalCost,           // روکش مالی!A11 = Fittings!A31\n      painting: costs.painting.totalCost,           // روکش مالی!A12 = Painting!A31\n      woodTools: costs.woodTools.totalCost,         // روکش مالی!A13 = WoodTools!A28\n      plate: costs.plate.totalCost,                 // روکش مالی!A14 = Plate!A31\n    };\n\n    // Calculate subtotal (SUM of all category costs)\n    // روکش مالی!SUM(A7:A26) - though only A7-A14 have values\n    const subtotal = sum(Object.values(breakdown));\n\n    // Calculate overheads\n    // روکش مالی!A27-A31\n    const overhead1 = subtotal * pricingConfig.overhead1;     // A27\n    const overhead2 = subtotal * pricingConfig.overhead2;     // A28\n    const overhead3 = subtotal * pricingConfig.overhead3;     // A29\n    const overhead4 = subtotal * pricingConfig.overhead4;     // A30\n    const contingency = subtotal * pricingConfig.contingency; // A31\n\n    const totalOverheads = sum([\n      overhead1,\n      overhead2,\n      overhead3,\n      overhead4,\n      contingency,\n    ]);\n\n    // Calculate total with overheads\n    // روکش مالی!A32 = SUM(A7:A26) + SUM(A27:A31)\n    const totalWithOverheads = subtotal + totalOverheads;\n\n    // Calculate profit amount\n    const profitAmount = totalWithOverheads * pricingConfig.profitMargin;\n\n    // Calculate final price with profit (22%)\n    // روکش مالی!A33 = A32 + (A32 * 0.22)\n    const finalPrice = totalWithOverheads + profitAmount;\n\n    return {\n      subtotal,\n      breakdown,\n      overheads: {\n        overhead1,\n        overhead2,\n        overhead3,\n        overhead4,\n        contingency,\n        totalOverheads,\n      },\n      totalWithOverheads,\n      finalPrice,\n      profitAmount,\n      profitPercentage: pricingConfig.profitMargin,\n    };\n  }\n\n  /**\n   * Get default pricing configuration\n   */\n  getDefaultConfig(): PricingConfig {\n    return { ...this.defaultConfig };\n  }\n\n  /**\n   * Update pricing configuration\n   */\n  setConfig(config: Partial<PricingConfig>): void {\n    this.defaultConfig = { ...this.defaultConfig, ...config };\n  }\n\n  /**\n   * Calculate just the overhead amount for a given subtotal\n   * Used in intermediate calculations\n   */\n  calculateOverheads(\n    subtotal: number,\n    config?: Partial<PricingConfig>\n  ): number {\n    const pricingConfig = { ...this.defaultConfig, ...config };\n    \n    return (\n      subtotal * pricingConfig.overhead1 +\n      subtotal * pricingConfig.overhead2 +\n      subtotal * pricingConfig.overhead3 +\n      subtotal * pricingConfig.overhead4 +\n      subtotal * pricingConfig.contingency\n    );\n  }\n\n  /**\n   * Calculate final price from subtotal (including overheads and profit)\n   * Quick calculation without full breakdown\n   */\n  calculateFinalPriceFromSubtotal(\n    subtotal: number,\n    config?: Partial<PricingConfig>\n  ): number {\n    const overheads = this.calculateOverheads(subtotal, config);\n    const totalWithOverheads = subtotal + overheads;\n    const pricingConfig = { ...this.defaultConfig, ...config };\n    return totalWithOverheads * (1 + pricingConfig.profitMargin);\n  }\n\n  /**\n   * Calculate subtotal from final price (reverse calculation)\n   * Useful for price verification\n   */\n  calculateSubtotalFromFinalPrice(\n    finalPrice: number,\n    config?: Partial<PricingConfig>\n  ): number {\n    const pricingConfig = { ...this.defaultConfig, ...config };\n    \n    // Calculate total overhead percentage\n    const totalOverheadPercentage =\n      pricingConfig.overhead1 +\n      pricingConfig.overhead2 +\n      pricingConfig.overhead3 +\n      pricingConfig.overhead4 +\n      pricingConfig.contingency;\n    \n    // Total multiplier: (1 + overheads) * (1 + profit)\n    const totalMultiplier = (1 + totalOverheadPercentage) * (1 + pricingConfig.profitMargin);\n    \n    return finalPrice / totalMultiplier;\n  }\n\n  /**\n   * Get pricing breakdown as percentages\n   * Useful for reporting and visualization\n   */\n  getPricingBreakdownPercentages(config?: Partial<PricingConfig>): {\n    overhead1Percent: number;\n    overhead2Percent: number;\n    overhead3Percent: number;\n    overhead4Percent: number;\n    contingencyPercent: number;\n    profitPercent: number;\n    totalOverheadPercent: number;\n  } {\n    const pricingConfig = { ...this.defaultConfig, ...config };\n    \n    return {\n      overhead1Percent: pricingConfig.overhead1 * 100,\n      overhead2Percent: pricingConfig.overhead2 * 100,\n      overhead3Percent: pricingConfig.overhead3 * 100,\n      overhead4Percent: pricingConfig.overhead4 * 100,\n      contingencyPercent: pricingConfig.contingency * 100,\n      profitPercent: pricingConfig.profitMargin * 100,\n      totalOverheadPercent: (\n        pricingConfig.overhead1 +\n        pricingConfig.overhead2 +\n        pricingConfig.overhead3 +\n        pricingConfig.overhead4 +\n        pricingConfig.contingency\n      ) * 100,\n    };\n  }\n}\n\n"],"names":["PricingService","getActiveConfig","dbConfig","prisma","pricingConfig","findFirst","where","isActive","orderBy","createdAt","overhead1","overhead2","overhead3","overhead4","contingency","profitMargin","defaultConfig","calculateFinancialSummary","costs","config","activeConfig","breakdown","material","totalCost","boreshKari","navarShiar","cnc","fittings","painting","woodTools","plate","subtotal","sum","Object","values","totalOverheads","totalWithOverheads","profitAmount","finalPrice","overheads","profitPercentage","getDefaultConfig","setConfig","calculateOverheads","calculateFinalPriceFromSubtotal","calculateSubtotalFromFinalPrice","totalOverheadPercentage","totalMultiplier","getPricingBreakdownPercentages","overhead1Percent","overhead2Percent","overhead3Percent","overhead4Percent","contingencyPercent","profitPercent","totalOverheadPercent"],"mappings":"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"}