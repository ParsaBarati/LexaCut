{"version":3,"sources":["../../../src/modules/cost-calculation/cost-calculation.service.ts"],"sourcesContent":["import { Injectable } from '@nestjs/common';\nimport {\n  ProcessedComponent,\n  ComponentData,\n  ProjectData,\n  CostBreakdown,\n  CalculationResult,\n  BoreshKariCategory,\n  CNCCategory,\n  NavarShiarCategory,\n  FittingsCategory,\n  PaintingCategory,\n  PlateCategory,\n  WoodToolsCategory,\n  CostItem,\n} from '../../common/interfaces';\nimport { MaterialsService } from '../materials/materials.service';\nimport { PricingService } from '../pricing/pricing.service';\nimport { PricingLookupService } from '../../common/utils/pricing-lookup.service';\nimport { sum, round, roundUp, trim, replace } from '../../common/utils/excel-functions';\n\n/**\n * Cost Calculation Service\n * Main orchestrator that implements the complete Excel calculation flow\n * Processes raw CSV data through all calculation steps\n */\n@Injectable()\nexport class CostCalculationService {\n  constructor(\n    private readonly materialsService: MaterialsService,\n    private readonly pricingService: PricingService,\n    private readonly pricingLookup: PricingLookupService\n  ) {}\n\n  /**\n   * Main calculation method - processes entire CSV input\n   * Replicates complete Excel VBA macro flow\n   * \n   * @param components - Raw component data from CSV\n   * @param projectData - Project metadata\n   * @returns Complete calculation result with financial summary\n   */\n  async calculateFullCost(\n    components: ComponentData[],\n    projectData: ProjectData\n  ): Promise<CalculationResult> {\n    // Step 1: Process components (clean, calculate fields)\n    // Replicates VBA data processing from \"All\" sheet\n    const processedComponents = this.processComponents(components, projectData.wastePercentage);\n\n    // Step 2: Calculate Material costs\n    // Replicates Material() macro and Material sheet\n    const materialCosts = await this.materialsService.calculateMaterialCosts(processedComponents);\n\n    // Step 3: Calculate BoreshKari (Cutting) costs\n    // Replicates BoreshKari() macro\n    // NOTE: Disabled for now - BoreshKari is not calculated in the Excel file for standard scenarios\n    // const boreshKariCosts = this.calculateBoreshKariCosts(processedComponents);\n    const boreshKariCosts = {\n      category: 'BoreshKari',\n      items: [],\n      totalCost: 0,\n    };\n\n    // Step 4: Calculate CNC costs\n    // Replicates CNC processing\n    const cncCosts = this.calculateCNCCosts(processedComponents);\n\n    // Step 5: Calculate NavarShiar (Edge Banding) costs\n    // Replicates NavarShiarFarsi sheet\n    const navarShiarCosts = this.calculateNavarShiarCosts(processedComponents);\n\n    // Step 6: Calculate Fittings costs\n    // Replicates Fittings() macro with Pivot Table\n    const fittingsCosts = this.calculateFittingsCosts(processedComponents);\n\n    // Step 7: Calculate Painting costs\n    // Replicates Painting sheet\n    // NOTE: Disabled for now - Painting is not calculated in the Excel file for standard scenarios\n    // const paintingCosts = this.calculatePaintingCosts(processedComponents);\n    const paintingCosts = {\n      category: 'Painting',\n      items: [],\n      totalCost: 0,\n    };\n\n    // Step 8: Calculate Plate costs\n    // Replicates Plate sheet\n    const plateCosts = this.calculatePlateCosts(processedComponents);\n\n    // Step 9: Calculate WoodTools costs\n    // Replicates WoodTools sheet\n    const woodToolsCosts = this.calculateWoodToolsCosts(processedComponents);\n\n    // Step 10: Aggregate all costs\n    const costs: CostBreakdown = {\n      material: materialCosts,\n      boreshKari: boreshKariCosts,\n      cnc: cncCosts,\n      navarShiar: navarShiarCosts,\n      fittings: fittingsCosts,\n      painting: paintingCosts,\n      plate: plateCosts,\n      woodTools: woodToolsCosts,\n    };\n\n    // Step 11: Calculate financial summary with overheads\n    // Replicates \"روکش مالی\" sheet\n    const financialSummary = await this.pricingService.calculateFinancialSummary(costs);\n\n    return {\n      project: {\n        name: projectData.projectName,\n        client: projectData.clientName,\n        date: projectData.contractDate,\n      },\n      costs,\n      financialSummary,\n      calculatedAt: new Date(),\n      version: '1.0.0',\n    };\n  }\n\n  /**\n   * Process raw components - clean and calculate fields\n   * Replicates VBA data processing in \"All\" sheet\n   */\n  private processComponents(\n    components: ComponentData[],\n    wastePercentage: number\n  ): ProcessedComponent[] {\n    return components.map((component) => {\n      // Clean instance type - remove \"CNC-\" prefix and trim\n      // Excel: Sheets(\"all\").Columns(\"AJ\").Replace what:=\"CNC-\", Replacement:=\"\"\n      let cleanedInstanceType = replace(component.instanceType, 'CNC-', '');\n      cleanedInstanceType = trim(cleanedInstanceType);\n\n      // Calculate sumArea (Quantity * Area)\n      // Excel: Column X = Cells(i, 3) * Cells(i, 11)\n      const sumArea = component.quantity * component.area;\n\n      // Calculate section1Value\n      // Excel: Cells(i, 24) = Cells(i, 3) * Cells(i, 11)\n      const section1Value = component.quantity * component.area;\n\n      // Calculate lengthQuantity (Length * Quantity) / 100\n      // Excel: BA column = ((Cells(i, 50) * Cells(i, 52))) / 100\n      const lengthQuantity = (component.length * component.quantity) / 100;\n\n      // Calculate areaWithWaste (Length * Width * Quantity) * (1 + waste%) / 10000\n      // Excel: BB column\n      const areaWithWaste =\n        (component.length * component.width * component.quantity * (1 + wastePercentage)) / 10000;\n\n      // Calculate doubleAreaWithWaste\n      // Excel: BC column = ((L * W * Q) * 2) * (1 + waste%) / 10000\n      const doubleAreaWithWaste =\n        ((component.length * component.width * component.quantity * 2) * (1 + wastePercentage)) / 10000;\n\n      // VLOOKUP color from pricing table (if needed)\n      const color = this.pricingLookup.getColorByCode(component.materialType);\n\n      return {\n        ...component,\n        sumArea,\n        section1Value,\n        lengthQuantity,\n        areaWithWaste,\n        doubleAreaWithWaste,\n        cleanInstanceType: cleanedInstanceType,\n        color,\n      };\n    });\n  }\n\n  /**\n   * Calculate BoreshKari (Cutting) costs\n   * Replicates BoreshKari() VBA macro\n   */\n  private calculateBoreshKariCosts(components: ProcessedComponent[]): BoreshKariCategory {\n    const items: CostItem[] = [];\n    let totalCost = 0;\n\n    // Filter components that need cutting operations\n    const cuttingComponents = components.filter(c => c.length > 0 && c.width > 0);\n\n    for (const component of cuttingComponents) {\n      // VLOOKUP cutting prices\n      const cuttingInfo = this.pricingLookup.getCuttingByCode('CUT001');\n      const unitPrice = cuttingInfo?.unitPrice || 2000;\n\n      // Calculate based on perimeter or area\n      const perimeter = 2 * (component.length + component.width) / 1000; // Convert mm to m\n      const cost = round(perimeter * unitPrice * component.quantity, 0);\n\n      if (cost > 0) {\n        items.push({\n          cost,\n          description: 'Cutting Operation',\n          unit: 'm',\n          quantity: perimeter * component.quantity,\n          code: component.materialType,\n        });\n        \n        totalCost += cost;\n      }\n    }\n\n    return {\n      category: 'BoreshKari',\n      items,\n      totalCost: round(totalCost, 0),\n    };\n  }\n\n  /**\n   * Calculate CNC costs\n   */\n  private calculateCNCCosts(components: ProcessedComponent[]): CNCCategory {\n    const items: CostItem[] = [];\n    let totalCost = 0;\n\n    // Filter components with CNC in instance type\n    const cncComponents = components.filter(c => \n      c.instanceType.toUpperCase().includes('CNC') || \n      c.cleanInstanceType.toUpperCase().includes('CNC')\n    );\n\n    for (const component of cncComponents) {\n      // Parse CNC operation type from cleanInstanceType\n      // Examples: \"Drill\" -> CNC001, \"Route\" -> CNC002, \"Complex\" -> CNC003\n      let cncCode = 'CNC001'; // Default to drilling\n      const operationType = component.cleanInstanceType.toUpperCase();\n      \n      if (operationType.includes('ROUTE')) {\n        cncCode = 'CNC002'; // Routing\n      } else if (operationType.includes('COMPLEX')) {\n        cncCode = 'CNC003'; // Complex cut\n      } else if (operationType.includes('DRILL')) {\n        cncCode = 'CNC001'; // Drilling\n      }\n\n      const cncInfo = this.pricingLookup.getCNCOperationByCode(cncCode);\n      const unitPrice = cncInfo?.unitPrice || 5000;\n      const cost = round(unitPrice * component.quantity, 0);\n\n      items.push({\n        cost,\n        description: `CNC - ${component.name}`,\n        unit: 'piece',\n        quantity: component.quantity,\n        code: operationType,\n      });\n\n      totalCost += cost;\n    }\n\n    return {\n      category: 'CNC',\n      items,\n      totalCost: round(totalCost, 0),\n    };\n  }\n\n  /**\n   * Calculate NavarShiar (Edge Banding) costs\n   */\n  private calculateNavarShiarCosts(components: ProcessedComponent[]): NavarShiarCategory {\n    const items: CostItem[] = [];\n    let totalCost = 0;\n\n    for (const component of components) {\n      // Count edges that need banding\n      const edges = [component.edge1, component.edge2, component.edge3, component.edge4];\n      const edgesToBand = edges.filter(e => e && e.trim() !== '').length;\n\n      if (edgesToBand > 0) {\n        // Calculate perimeter length\n        const perimeterPerEdge = (component.length + component.width) / 1000; // mm to m\n        const totalLength = perimeterPerEdge * edgesToBand * component.quantity;\n\n        const edgeInfo = this.pricingLookup.getEdgeBandingByCode('EDGE001');\n        const unitPrice = edgeInfo?.unitPrice || 3500;\n        const cost = round(totalLength * unitPrice, 0);\n\n        items.push({\n          cost,\n          description: `Edge Banding - ${component.name}`,\n          unit: 'm',\n          quantity: totalLength,\n          code: component.materialType,\n        });\n\n        totalCost += cost;\n      }\n    }\n\n    return {\n      category: 'NavarShiar',\n      items,\n      totalCost: round(totalCost, 0),\n    };\n  }\n\n  /**\n   * Calculate Fittings costs\n   * Replicates Fittings() VBA macro with intelligent component matching\n   * \n   * Excel logic: FittingsData sheet with pivot tables\n   * TypeScript: Heuristic matching based on component names/types\n   */\n  private calculateFittingsCosts(components: ProcessedComponent[]): FittingsCategory {\n    const items: CostItem[] = [];\n    const fittingAggregation: Record<string, { code: string; description: string; unit: string; unitPrice: number; quantity: number }> = {};\n    \n    for (const component of components) {\n      const nameLower = component.name.toLowerCase();\n      const instanceLower = component.instanceType.toLowerCase();\n      const combinedText = `${nameLower} ${instanceLower}`;\n      \n      // Heuristic matching rules based on component names\n      // Door components → Hinges (2 per door)\n      if (combinedText.includes('door') || combinedText.includes('درب') || combinedText.includes('cabinet door')) {\n        this.addFitting(fittingAggregation, 'FITTING-1', 'لولا گازور -آرام بند', 'عدد', 200000, 2 * component.quantity);\n      }\n      \n      // Drawer components → Drawer rails\n      if (combinedText.includes('drawer') || combinedText.includes('کشو')) {\n        // Determine drawer size based on width\n        const drawerWidth = component.width;\n        let fittingCode = 'FITTING-3'; // Default 50cm\n        let fittingPrice = 700000;\n        \n        if (drawerWidth >= 500) {\n          fittingCode = 'FITTING-3'; // 50cm\n          fittingPrice = 700000;\n        } else if (drawerWidth >= 450) {\n          fittingCode = 'FITTING-4'; // 45cm\n          fittingPrice = 600000;\n        } else if (drawerWidth >= 400) {\n          fittingCode = 'FITTING-5'; // 40cm\n          fittingPrice = 550000;\n        } else if (drawerWidth >= 350) {\n          fittingCode = 'FITTING-6'; // 35cm\n          fittingPrice = 500000;\n        } else if (drawerWidth >= 300) {\n          fittingCode = 'FITTING-7'; // 30cm\n          fittingPrice = 450000;\n        } else {\n          fittingCode = 'FITTING-8'; // 25cm\n          fittingPrice = 400000;\n        }\n        \n        this.addFitting(fittingAggregation, fittingCode, `ریل ساچمه ای`, 'جفت', fittingPrice, component.quantity);\n        \n        // Drawers also need handles\n        this.addFitting(fittingAggregation, 'FITTING-10', 'دستکیره کابینت', 'عدد', 450000, component.quantity);\n      }\n      \n      // Cabinet components with handles\n      if ((combinedText.includes('cabinet') || combinedText.includes('کابینت')) && \n          !combinedText.includes('door') && \n          !combinedText.includes('drawer')) {\n        this.addFitting(fittingAggregation, 'FITTING-10', 'دستکیره کابینت', 'عدد', 450000, component.quantity);\n      }\n      \n      // Shelves or components needing support legs\n      if (combinedText.includes('base') || combinedText.includes('پایه') || \n          (combinedText.includes('shelf') && component.area > 0.5)) {\n        // Add legs - 4 per component typically\n        this.addFitting(fittingAggregation, 'FITTING-19', 'پایه 14 سانتی', 'عدد', 120000, 4 * component.quantity);\n      }\n      \n      // Hanging components\n      if (combinedText.includes('hanger') || combinedText.includes('آویز')) {\n        this.addFitting(fittingAggregation, 'FITTING-12', 'جا آویز لباس', 'عدد', 200000, component.quantity);\n      }\n      \n      // Lift-up door mechanism\n      if (combinedText.includes('lift') || combinedText.includes('jack') || combinedText.includes('جک')) {\n        this.addFitting(fittingAggregation, 'FITTING-9', 'جک 120', 'عدد', 250000, component.quantity);\n      }\n    }\n    \n    // Convert aggregation to items array\n    let totalCost = 0;\n    for (const [key, fitting] of Object.entries(fittingAggregation)) {\n      const cost = round(fitting.unitPrice * fitting.quantity, 0);\n      items.push({\n        cost,\n        description: fitting.description,\n        unit: fitting.unit,\n        quantity: fitting.quantity,\n        code: fitting.code,\n      });\n      totalCost += cost;\n    }\n    \n    return {\n      category: 'Fittings',\n      items,\n      totalCost: round(totalCost, 0),\n    };\n  }\n  \n  /**\n   * Helper method to add or aggregate fittings\n   */\n  private addFitting(\n    aggregation: Record<string, { code: string; description: string; unit: string; unitPrice: number; quantity: number }>,\n    code: string,\n    description: string,\n    unit: string,\n    unitPrice: number,\n    quantity: number\n  ): void {\n    if (aggregation[code]) {\n      aggregation[code].quantity += quantity;\n    } else {\n      aggregation[code] = { code, description, unit, unitPrice, quantity };\n    }\n  }\n\n  /**\n   * Calculate Painting costs\n   */\n  private calculatePaintingCosts(components: ProcessedComponent[]): PaintingCategory {\n    const items: CostItem[] = [];\n    const paintingPricePerM2 = 50000; // Example price per m²\n    let totalCost = 0;\n\n    for (const component of components) {\n      const area = component.area * component.quantity;\n      const cost = round(area * paintingPricePerM2, 0);\n\n      if (cost > 0) {\n        items.push({\n          cost,\n          description: `Painting - ${component.name}`,\n          unit: 'm²',\n          quantity: area,\n        });\n        \n        totalCost += cost;\n      }\n    }\n\n    return {\n      category: 'Painting',\n      items,\n      totalCost: round(totalCost, 0),\n    };\n  }\n\n  /**\n   * Calculate Plate costs\n   * Replicates Plate sheet calculations\n   * For thin sheet materials or materials categorized as \"Plate\"\n   */\n  private calculatePlateCosts(components: ProcessedComponent[]): PlateCategory {\n    const items: CostItem[] = [];\n    let totalCost = 0;\n    \n    // Filter components that are plates (thin materials, typically < 5mm)\n    const plateComponents = components.filter(c => {\n      const thickness = c.cutting_thickness || 0;\n      const materialLower = c.materialType.toLowerCase();\n      \n      // Consider as plate if:\n      // 1. Thickness < 5mm\n      // 2. Material name contains \"plate\" or \"sheet\" or \"صفحه\"\n      return thickness < 5 || \n             materialLower.includes('plate') || \n             materialLower.includes('sheet') ||\n             materialLower.includes('صفحه') ||\n             materialLower.includes('3 میل'); // 3mm materials\n    });\n    \n    if (plateComponents.length === 0) {\n      return {\n        category: 'Plate',\n        items: [],\n        totalCost: 0,\n      };\n    }\n    \n    // Group by material type (similar to material calculation)\n    const plateGroups = this.groupByMaterial(plateComponents);\n    \n    for (const [materialType, groupData] of Object.entries(plateGroups)) {\n      // Use pricing lookup to get material info\n      const materialInfo = this.pricingLookup.getMaterialByName(materialType);\n      const unitPrice = materialInfo ? (materialInfo as any).unitPrice || 3500000 : 3500000; // Default to 3mm MDF price\n      \n      const groupArea = groupData.totalArea;\n      const cost = round(groupArea * unitPrice, 0);\n      \n      items.push({\n        cost,\n        description: `Plate - ${materialType}`,\n        unit: 'متر مربع',\n        quantity: groupArea,\n        code: materialType,\n      });\n      \n      totalCost += cost;\n    }\n    \n    return {\n      category: 'Plate',\n      items,\n      totalCost: round(totalCost, 0),\n    };\n  }\n  \n  /**\n   * Helper to group components by material (used for plate calculation too)\n   */\n  private groupByMaterial(components: ProcessedComponent[]): Record<string, {\n    totalArea: number;\n    count: number;\n    components: ProcessedComponent[];\n  }> {\n    const groups: Record<string, {\n      totalArea: number;\n      count: number;\n      components: ProcessedComponent[];\n    }> = {};\n\n    for (const component of components) {\n      const materialKey = component.materialType;\n      \n      if (!groups[materialKey]) {\n        groups[materialKey] = {\n          totalArea: 0,\n          count: 0,\n          components: [],\n        };\n      }\n\n      groups[materialKey].totalArea += component.sumArea || component.area;\n      groups[materialKey].count += 1;\n      groups[materialKey].components.push(component);\n    }\n\n    return groups;\n  }\n\n  /**\n   * Calculate WoodTools costs\n   * Replicates WoodTools sheet calculations\n   * Fixed tooling costs based on project complexity\n   * Note: Uses A28 instead of A31 in Excel\n   */\n  private calculateWoodToolsCosts(components: ProcessedComponent[]): WoodToolsCategory {\n    const items: CostItem[] = [];\n    \n    // Base tooling cost for any project\n    const baseCost = 500000; // 500,000 Rials base cost\n    items.push({\n      cost: baseCost,\n      description: 'هزینه پایه ابزار چوبی',\n      unit: 'پروژه',\n      quantity: 1,\n    });\n    \n    // Additional cost per unique material type\n    const uniqueMaterials = new Set(components.map(c => c.materialType));\n    const materialComplexityCost = (uniqueMaterials.size - 1) * 50000; // 50,000 per additional material\n    if (materialComplexityCost > 0) {\n      items.push({\n        cost: materialComplexityCost,\n        description: 'پیچیدگی مواد متنوع',\n        unit: 'تنوع',\n        quantity: uniqueMaterials.size - 1,\n      });\n    }\n    \n    // Additional cost for CNC components (require special tooling)\n    const cncComponents = components.filter(c => \n      c.instanceType.toUpperCase().includes('CNC') || \n      c.cleanInstanceType?.toUpperCase().includes('CNC')\n    );\n    const cncComplexityCost = cncComponents.length * 20000; // 20,000 per CNC component\n    if (cncComplexityCost > 0) {\n      items.push({\n        cost: cncComplexityCost,\n        description: 'ابزار ویژه CNC',\n        unit: 'قطعه',\n        quantity: cncComponents.length,\n      });\n    }\n    \n    // Calculate total\n    const totalCost = items.reduce((sum, item) => sum + item.cost, 0);\n    \n    return {\n      category: 'WoodTools',\n      items,\n      totalCost: round(totalCost, 0),\n    };\n  }\n}\n\n"],"names":["CostCalculationService","calculateFullCost","components","projectData","processedComponents","processComponents","wastePercentage","materialCosts","materialsService","calculateMaterialCosts","boreshKariCosts","category","items","totalCost","cncCosts","calculateCNCCosts","navarShiarCosts","calculateNavarShiarCosts","fittingsCosts","calculateFittingsCosts","paintingCosts","plateCosts","calculatePlateCosts","woodToolsCosts","calculateWoodToolsCosts","costs","material","boreshKari","cnc","navarShiar","fittings","painting","plate","woodTools","financialSummary","pricingService","calculateFinancialSummary","project","name","projectName","client","clientName","date","contractDate","calculatedAt","Date","version","map","component","cleanedInstanceType","replace","instanceType","trim","sumArea","quantity","area","section1Value","lengthQuantity","length","areaWithWaste","width","doubleAreaWithWaste","color","pricingLookup","getColorByCode","materialType","cleanInstanceType","calculateBoreshKariCosts","cuttingComponents","filter","c","cuttingInfo","getCuttingByCode","unitPrice","perimeter","cost","round","push","description","unit","code","cncComponents","toUpperCase","includes","cncCode","operationType","cncInfo","getCNCOperationByCode","edges","edge1","edge2","edge3","edge4","edgesToBand","e","perimeterPerEdge","totalLength","edgeInfo","getEdgeBandingByCode","fittingAggregation","nameLower","toLowerCase","instanceLower","combinedText","addFitting","drawerWidth","fittingCode","fittingPrice","key","fitting","Object","entries","aggregation","calculatePaintingCosts","paintingPricePerM2","plateComponents","thickness","cutting_thickness","materialLower","plateGroups","groupByMaterial","groupData","materialInfo","getMaterialByName","groupArea","totalArea","groups","materialKey","count","baseCost","uniqueMaterials","Set","materialComplexityCost","size","cncComplexityCost","reduce","sum","item"],"mappings":"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"}