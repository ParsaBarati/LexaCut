{"version":3,"sources":["../../../src/modules/cost-calculation/data-processing.service.ts"],"sourcesContent":["import { Injectable } from '@nestjs/common';\nimport { ComponentData, ProcessedComponent } from '../../common/interfaces';\nimport { PricingLookupService } from '../../common/utils/pricing-lookup.service';\nimport { trim, replace } from '../../common/utils/excel-functions';\n\n/**\n * Data Processing Service\n * Replicates VBA CopyP1() macro\n * \n * Excel References:\n * - VBA: Sub CopyP1() in Module5.bas\n * - Copies from All sheet to P1 sheet\n * - Processes and cleans data\n * - Calculates additional fields (BA, BB, BC columns)\n */\n@Injectable()\nexport class DataProcessingService {\n  constructor(private readonly pricingLookup: PricingLookupService) {}\n\n  /**\n   * Process raw CSV data - Replicates CopyP1() VBA macro\n   * \n   * Excel Flow:\n   * 1. Sheets(\"all\").Range(Range(\"a2\"), Cells(Lastcount, \"c\")).Copy Sheets(\"p1\").Range(\"b11\")\n   * 2. Clean \"CNC-\" prefix: Sheets(\"all\").Columns(\"AJ\").Replace what:=\"CNC-\", Replacement:=\"\"\n   * 3. Trim values: Application.WorksheetFunction.Trim(iCells.Value)\n   * 4. Calculate Section 1: Cells(i, 24) = Cells(i, 3) * Cells(i, 11)\n   * 5. Calculate BA: Cells(i, 53) = ((Cells(i, 50) * Cells(i, 52))) / 100\n   * 6. Calculate BB: Cells(i, 54) = (Length * Width * Qty) * (1 + waste%) / 10000\n   * 7. Calculate BC: Cells(i, 55) = ((Length * Width * Qty) * 2) * (1 + waste%) / 10000\n   * 8. VLOOKUP colors: DataDsc.Value = VLOOKUP(DataCode, MyRange, 2, 0)\n   */\n  processAllSheetData(\n    components: ComponentData[],\n    wastePercentage: number\n  ): ProcessedComponent[] {\n    return components.map((component) => {\n      // Excel: Sheets(\"all\").Columns(\"AJ\").Replace what:=\"CNC-\", Replacement:=\"\"\n      // Remove \"CNC-\" prefix from instance type\n      let cleanedInstanceType = replace(component.instanceType || '', 'CNC-', '');\n      \n      // Excel: Application.WorksheetFunction.Trim(iCells.Value)\n      // Trim whitespace\n      cleanedInstanceType = trim(cleanedInstanceType);\n\n      // Excel: Cells(i, 24) = Cells(i, 3) * Cells(i, 11)\n      // Calculate sumArea (Quantity * Area)\n      // Column X (24) = Column C (3) * Column L (11)\n      const sumArea = component.quantity * component.area;\n\n      // Excel: Cells(i, 24) = Cells(i, 3) * Cells(i, 11)\n      // Section1Value is same as sumArea\n      const section1Value = sumArea;\n\n      // Excel: Cells(i, 53) = ((Cells(i, 50) * Cells(i, 52))) / 100\n      // Calculate lengthQuantity: (Length * Quantity) / 100\n      // Column BA (53) = (Column AX (50) * Column AZ (52)) / 100\n      const lengthQuantity = (component.length * component.quantity) / 100;\n\n      // Excel: Cells(i, 54) = (((Cells(i, 50) * Cells(i, 51) * Cells(i, 52))) * (((Sheets(\"Data\").Range(\"E2\"))) + 1) / 100) / 100\n      // Calculate areaWithWaste: (L * W * Q) * (1 + waste%) / 10000\n      // Column BB (54) = (AX * AY * AZ) * (1 + Data!E2) / 10000\n      const areaWithWaste =\n        (component.length * component.width * component.quantity * (1 + wastePercentage)) / 10000;\n\n      // Excel: Cells(i, 55) = ((((Cells(i, 50) * Cells(i, 51) * Cells(i, 52)) * 2) * (((Sheets(\"Data\").Range(\"E2\"))) + 1)) / 100) / 100\n      // Calculate doubleAreaWithWaste: ((L * W * Q) * 2) * (1 + waste%) / 10000\n      // Column BC (55) = ((AX * AY * AZ) * 2) * (1 + Data!E2) / 10000\n      const doubleAreaWithWaste =\n        ((component.length * component.width * component.quantity * 2) * (1 + wastePercentage)) / 10000;\n\n      // Excel: Set MyRange = Sheets(\"Data\").Range(\"L:M\")\n      // Excel: DataDsc.Value = Application.WorksheetFunction.VLookup(DataCode, MyRange, 2, 0)\n      // VLOOKUP color from Data sheet (L:M range)\n      // Column AT = VLOOKUP(Column AU, Data!L:M, 2, 0)\n      const color = this.pricingLookup.getColorByCode(component.materialType);\n\n      return {\n        ...component,\n        sumArea,\n        section1Value,\n        lengthQuantity,\n        areaWithWaste,\n        doubleAreaWithWaste,\n        cleanInstanceType: cleanedInstanceType,\n        color,\n      };\n    });\n  }\n\n  /**\n   * Copy data to P1 sheet equivalent\n   * Replicates the copy operations in CopyP1() macro\n   * \n   * Excel: Sheets(\"all\").Range(Range(\"a2\"), Cells(Lastcount, \"c\")).Copy Sheets(\"p1\").Range(\"b11\")\n   */\n  copyToP1Sheet(components: ProcessedComponent[]): ProcessedComponent[] {\n    // In our implementation, P1 is just the processed component array\n    // Excel copies columns A-C, I-J, H to different positions\n    // We maintain all data in the ProcessedComponent structure\n    return components;\n  }\n\n  /**\n   * Validate processed data\n   * Ensures all required fields are present and valid\n   */\n  validateProcessedData(components: ProcessedComponent[]): {\n    isValid: boolean;\n    errors: string[];\n  } {\n    const errors: string[] = [];\n\n    components.forEach((component, index) => {\n      // Check required fields\n      if (!component.name || component.name.trim() === '') {\n        errors.push(`Row ${index + 1}: Missing component name`);\n      }\n\n      if (component.quantity <= 0) {\n        errors.push(`Row ${index + 1}: Invalid quantity (${component.quantity})`);\n      }\n\n      if (component.length <= 0 || component.width <= 0) {\n        errors.push(`Row ${index + 1}: Invalid dimensions (L:${component.length}, W:${component.width})`);\n      }\n\n      if (component.area <= 0) {\n        errors.push(`Row ${index + 1}: Invalid area (${component.area})`);\n      }\n\n      // Check calculated fields\n      if (component.sumArea !== component.quantity * component.area) {\n        errors.push(`Row ${index + 1}: sumArea calculation mismatch`);\n      }\n    });\n\n    return {\n      isValid: errors.length === 0,\n      errors,\n    };\n  }\n\n  /**\n   * Get processing statistics\n   * For debugging and validation\n   */\n  getProcessingStats(components: ProcessedComponent[]): {\n    totalComponents: number;\n    totalQuantity: number;\n    totalArea: number;\n    totalSumArea: number;\n    uniqueMaterials: number;\n    cncComponents: number;\n  } {\n    return {\n      totalComponents: components.length,\n      totalQuantity: components.reduce((sum, c) => sum + c.quantity, 0),\n      totalArea: components.reduce((sum, c) => sum + c.area, 0),\n      totalSumArea: components.reduce((sum, c) => sum + c.sumArea, 0),\n      uniqueMaterials: new Set(components.map(c => c.materialType)).size,\n      cncComponents: components.filter(c => \n        c.instanceType.toUpperCase().includes('CNC') || \n        c.cleanInstanceType.toUpperCase().includes('CNC')\n      ).length,\n    };\n  }\n}\n\n"],"names":["DataProcessingService","processAllSheetData","components","wastePercentage","map","component","cleanedInstanceType","replace","instanceType","trim","sumArea","quantity","area","section1Value","lengthQuantity","length","areaWithWaste","width","doubleAreaWithWaste","color","pricingLookup","getColorByCode","materialType","cleanInstanceType","copyToP1Sheet","validateProcessedData","errors","forEach","index","name","push","isValid","getProcessingStats","totalComponents","totalQuantity","reduce","sum","c","totalArea","totalSumArea","uniqueMaterials","Set","size","cncComponents","filter","toUpperCase","includes"],"mappings":"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"}