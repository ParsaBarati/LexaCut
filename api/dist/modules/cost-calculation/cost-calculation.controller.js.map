{"version":3,"sources":["../../../src/modules/cost-calculation/cost-calculation.controller.ts"],"sourcesContent":["import {\n  Controller,\n  Post,\n  Body,\n  UploadedFile,\n  UseInterceptors,\n  HttpException,\n  HttpStatus,\n  Get,\n} from '@nestjs/common';\nimport { FileInterceptor } from '@nestjs/platform-express';\nimport { ApiTags, ApiOperation, ApiConsumes, ApiResponse } from '@nestjs/swagger';\nimport { Readable } from 'stream';\nimport { CostCalculationService } from './cost-calculation.service';\nimport {\n  CalculateFullCostDto,\n  ProjectDataDto,\n  PricingConfigDto,\n  DirectCalculationDto,\n  DirectPartDto,\n} from '../../common/dto/calculation.dto';\nimport { parseCSV, validateComponents } from '../../common/utils/csv-parser.util';\nimport { validateHeaders } from '../../common/utils/lexacut-column-mapper';\nimport { CalculationResult, ComponentData } from '../../common/interfaces';\n\n/**\n * Cost Calculation API Controller\n * Main endpoint for processing CSV and calculating costs\n */\n@ApiTags('Cost Calculation')\n@Controller('api/v1/calculate')\nexport class CostCalculationController {\n  constructor(\n    private readonly costCalculationService: CostCalculationService\n  ) {}\n\n  /**\n   * Calculate full cost from JSON payload\n   * POST /api/v1/calculate/full\n   */\n  @Post('full')\n  @ApiOperation({ summary: 'Calculate full project cost from JSON data' })\n  @ApiResponse({\n    status: 200,\n    description: 'Calculation result with financial summary',\n  })\n  @ApiResponse({ status: 400, description: 'Invalid input data' })\n  async calculateFullCost(\n    @Body() dto: CalculateFullCostDto\n  ): Promise<CalculationResult> {\n    try {\n      // Validate components\n      const validation = validateComponents(dto.components);\n      if (!validation.isValid) {\n        throw new HttpException(\n          {\n            message: 'Invalid component data',\n            errors: validation.errors,\n            warnings: validation.warnings,\n          },\n          HttpStatus.BAD_REQUEST\n        );\n      }\n\n      // Calculate\n      const result = await this.costCalculationService.calculateFullCost(\n        dto.components,\n        dto.projectData\n      );\n\n      return result;\n    } catch (error) {\n      if (error instanceof HttpException) {\n        throw error;\n      }\n      throw new HttpException(\n        {\n          message: 'Calculation failed',\n          error: error instanceof Error ? error.message : 'Unknown error',\n        },\n        HttpStatus.INTERNAL_SERVER_ERROR\n      );\n    }\n  }\n\n  /**\n   * Validate CSV file structure without running full calculation\n   * POST /api/v1/calculate/validate\n   */\n  @Post('validate')\n  @UseInterceptors(FileInterceptor('file'))\n  @ApiOperation({ summary: 'Validate CSV structure without calculation' })\n  @ApiConsumes('multipart/form-data')\n  @ApiResponse({\n    status: 200,\n    description: 'Validation result with detailed feedback',\n  })\n  @ApiResponse({ status: 400, description: 'Invalid file or structure' })\n  async validateCSV(\n    @UploadedFile() file: any\n  ): Promise<{\n    isValid: boolean;\n    format: 'lexacut' | 'legacy' | 'unknown';\n    headers: string[];\n    missingColumns?: string[];\n    extraColumns?: string[];\n    foundColumns?: string[];\n    rowCount: number;\n    validComponents: number;\n    errors?: string[];\n    warnings?: string[];\n  }> {\n    if (!file) {\n      throw new HttpException('No file uploaded', HttpStatus.BAD_REQUEST);\n    }\n\n    try {\n      // Parse CSV to get headers and basic structure\n      const stream = Readable.from(file.buffer);\n      const csv = require('csv-parser');\n      const rows: any[] = [];\n      let headers: string[] = [];\n\n      await new Promise((resolve, reject) => {\n        stream\n          .pipe(csv())\n          .on('headers', (hdrs: string[]) => {\n            headers = hdrs;\n          })\n          .on('data', (row: any) => {\n            rows.push(row);\n            // Only collect first 100 rows for validation\n            if (rows.length >= 100) {\n              resolve(rows);\n            }\n          })\n          .on('end', () => resolve(rows))\n          .on('error', reject);\n      });\n\n      // Validate headers against LexaCut format\n      const headerValidation = validateHeaders(headers);\n\n      // Determine format\n      const isLexaCutFormat = headers.some(h => h.toLowerCase() === 'cutting length');\n      const format = isLexaCutFormat ? 'lexacut' : \n                     headers.some(h => h.toLowerCase().includes('length - raw')) ? 'legacy' : \n                     'unknown';\n\n      // Try to parse components for additional validation\n      let validComponents = 0;\n      const errors: string[] = [];\n      const warnings: string[] = [];\n\n      try {\n        const stream2 = Readable.from(file.buffer);\n        const components = await parseCSV(stream2);\n        validComponents = components.length;\n\n        if (validComponents === 0) {\n          errors.push('No valid components found in CSV');\n        } else if (validComponents < rows.length * 0.5) {\n          warnings.push(`Only ${validComponents} out of ${rows.length} rows could be parsed as valid components`);\n        }\n      } catch (parseError: any) {\n        errors.push(`Parsing error: ${parseError.message}`);\n      }\n\n      // Add warnings for missing optional columns\n      if (!headerValidation.isValid && headerValidation.missingColumns.length > 0) {\n        warnings.push(`Missing recommended columns: ${headerValidation.missingColumns.join(', ')}`);\n      }\n\n      return {\n        isValid: headerValidation.isValid && validComponents > 0,\n        format,\n        headers,\n        missingColumns: headerValidation.missingColumns,\n        extraColumns: headerValidation.extraColumns,\n        foundColumns: headerValidation.foundColumns,\n        rowCount: rows.length,\n        validComponents,\n        errors: errors.length > 0 ? errors : undefined,\n        warnings: warnings.length > 0 ? warnings : undefined,\n      };\n    } catch (error: any) {\n      throw new HttpException(\n        {\n          message: 'Validation failed',\n          error: error instanceof Error ? error.message : 'Unknown error',\n        },\n        HttpStatus.BAD_REQUEST\n      );\n    }\n  }\n\n  /**\n   * Calculate cost directly from LexaCut plugin (no CSV)\n   * POST /api/v1/calculate/direct\n   */\n  @Post('direct')\n  @ApiOperation({ summary: 'Calculate cost from direct API call (LexaCut plugin)' })\n  @ApiResponse({\n    status: 200,\n    description: 'Calculation result with financial summary (JSON)',\n  })\n  @ApiResponse({ status: 400, description: 'Invalid request data' })\n  async calculateDirect(\n    @Body() dto: DirectCalculationDto\n  ): Promise<CalculationResult> {\n    try {\n      // Transform DirectPartDto to ComponentData format\n      const components: ComponentData[] = dto.parts.map(part => ({\n        name: part.name,\n        componentId: part.number,\n        quantity: part.count,\n        edge1: part.edge_ymin || '',\n        edge2: part.edge_ymax || '',\n        edge3: part.edge_xmin || '',\n        edge4: part.edge_xmax || '',\n        materialType: part.material_name,\n        instanceType: part.entity_names,\n        length: part.cutting_length,\n        width: part.cutting_width,\n        area: part.final_area,\n      }));\n\n      // Validate components\n      const validation = validateComponents(components);\n      if (!validation.isValid) {\n        throw new HttpException(\n          {\n            message: 'Component validation failed',\n            errors: validation.errors,\n          },\n          HttpStatus.BAD_REQUEST\n        );\n      }\n\n      // Calculate using the service\n      const result = await this.costCalculationService.calculateFullCost(\n        components,\n        dto.projectData\n      );\n\n      return result;\n    } catch (error: any) {\n      console.error('Direct calculation error:', error);\n      throw new HttpException(\n        {\n          message: 'Calculation failed',\n          error: error instanceof Error ? error.message : 'Unknown error',\n        },\n        HttpStatus.INTERNAL_SERVER_ERROR\n      );\n    }\n  }\n\n  /**\n   * Calculate cost from CSV file upload\n   * POST /api/v1/calculate/csv\n   */\n  @Post('csv')\n  @UseInterceptors(FileInterceptor('file'))\n  @ApiOperation({ summary: 'Calculate cost from CSV or Excel file upload' })\n  @ApiConsumes('multipart/form-data')\n  @ApiResponse({\n    status: 200,\n    description: 'Calculation result with financial summary (JSON)',\n  })\n  @ApiResponse({ status: 400, description: 'Invalid CSV/Excel file or data' })\n  async calculateFromCSV(\n    @UploadedFile() file: any,\n    @Body('projectData') projectDataJson: string\n  ): Promise<CalculationResult> {\n    if (!file) {\n      throw new HttpException('No file uploaded', HttpStatus.BAD_REQUEST);\n    }\n\n    try {\n      // Parse project data from JSON string\n      const projectData: ProjectDataDto = JSON.parse(projectDataJson);\n\n      // Parse CSV\n      const stream = Readable.from(file.buffer);\n      let components: ComponentData[];\n      \n      try {\n        components = await parseCSV(stream);\n      } catch (error) {\n        // If CSV parsing fails, show raw file content for debugging\n        const fileContent = file.buffer.toString('utf-8');\n        const firstLines = fileContent.split('\\n').slice(0, 5).join('\\n');\n        \n        throw new HttpException(\n          {\n            message: 'CSV parsing failed',\n            error: error instanceof Error ? error.message : 'Unknown error',\n            filePreview: firstLines,\n            fileSize: file.size,\n          },\n          HttpStatus.BAD_REQUEST\n        );\n      }\n\n      // Debug logging\n      console.log(`Parsed ${components.length} components from CSV`);\n      if (components.length > 0) {\n        console.log('First component:', JSON.stringify(components[0], null, 2));\n      } else {\n        // If no components, show raw CSV content for debugging\n        const fileContent = file.buffer.toString('utf-8');\n        const firstLines = fileContent.split('\\n').slice(0, 10).join('\\n');\n        console.log('CSV file content (first 10 lines):', firstLines);\n      }\n\n      // Validate\n      const validation = validateComponents(components);\n      if (!validation.isValid && components.length === 0) {\n        // If no components at all, show more details\n        const fileContent = file.buffer.toString('utf-8');\n        const firstLines = fileContent.split('\\n').slice(0, 10).join('\\n');\n        \n        throw new HttpException(\n          {\n            message: 'No valid components found in CSV',\n            errors: [\n              'CSV file appears to be empty or contains no valid data rows',\n              ...validation.errors.slice(0, 5), // Show first 5 errors\n            ],\n            warnings: validation.warnings.slice(0, 5),\n            csvPreview: firstLines,\n            hint: 'Please check that your CSV has the correct column headers: Length - raw, Width - raw, Quantity, Material name, etc.',\n          },\n          HttpStatus.BAD_REQUEST\n        );\n      }\n      \n      if (!validation.isValid) {\n        throw new HttpException(\n          {\n            message: 'Invalid CSV data',\n            errors: validation.errors,\n            warnings: validation.warnings,\n          },\n          HttpStatus.BAD_REQUEST\n        );\n      }\n\n      if (components.length === 0) {\n        throw new HttpException(\n          {\n            message: 'No valid components found in CSV',\n            errors: ['CSV file appears to be empty or contains no valid data rows'],\n          },\n          HttpStatus.BAD_REQUEST\n        );\n      }\n\n      // Calculate\n      const result = await this.costCalculationService.calculateFullCost(\n        components,\n        projectData\n      );\n\n      // Debug logging\n      console.log(`Calculation complete. Material cost: ${result.costs.material.totalCost}`);\n\n      return result;\n    } catch (error) {\n      if (error instanceof HttpException) {\n        throw error;\n      }\n      if (error instanceof SyntaxError) {\n        throw new HttpException(\n          'Invalid project data JSON',\n          HttpStatus.BAD_REQUEST\n        );\n      }\n      throw new HttpException(\n        {\n          message: 'CSV processing failed',\n          error: error instanceof Error ? error.message : 'Unknown error',\n        },\n        HttpStatus.INTERNAL_SERVER_ERROR\n      );\n    }\n  }\n\n  /**\n   * Get current pricing configuration\n   * GET /api/v1/calculate/config/pricing\n   */\n  @Get('config/pricing')\n  @ApiOperation({ summary: 'Get current pricing configuration' })\n  @ApiResponse({ status: 200, description: 'Pricing configuration' })\n  async getPricingConfig(): Promise<PricingConfigDto> {\n    // This would come from PricingService\n    return {\n      overhead1: 0.25,\n      overhead2: 0.04,\n      overhead3: 0.02,\n      overhead4: 0.02,\n      contingency: 0.025,\n      profitMargin: 0.22,\n    };\n  }\n\n  /**\n   * Debug endpoint - Parse file and show detailed information\n   * POST /api/v1/calculate/debug\n   */\n  @Post('debug')\n  @UseInterceptors(FileInterceptor('file'))\n  @ApiOperation({ summary: 'Debug: Parse file and show detailed parsing info' })\n  @ApiConsumes('multipart/form-data')\n  @ApiResponse({ status: 200, description: 'Detailed parsing information' })\n  async debugParse(\n    @UploadedFile() file: any\n  ): Promise<any> {\n    if (!file) {\n      throw new HttpException('No file uploaded', HttpStatus.BAD_REQUEST);\n    }\n\n    try {\n      const stream = Readable.from(file.buffer);\n      const components = await parseCSV(stream);\n      \n      // Calculate costs to show full processing\n      const projectData: ProjectDataDto = {\n        name: 'Debug Test',\n        client: 'Debug',\n        date: new Date().toISOString().split('T')[0],\n      };\n      \n      const result = await this.costCalculationService.calculateFullCost(\n        components,\n        projectData\n      );\n\n      return {\n        fileInfo: {\n          originalName: file.originalname,\n          size: file.size,\n          mimetype: file.mimetype,\n          isExcel: file.buffer[0] === 0x50 && file.buffer[1] === 0x4B,\n        },\n        parsed: {\n          componentCount: components.length,\n          components: components.map(comp => ({\n            name: comp.name,\n            componentId: comp.componentId,\n            quantity: comp.quantity,\n            length: comp.length,\n            width: comp.width,\n            area: comp.area,\n            materialType: comp.materialType,\n            instanceType: comp.instanceType,\n            edges: {\n              edge1: comp.edge1,\n              edge2: comp.edge2,\n              edge3: comp.edge3,\n              edge4: comp.edge4,\n            },\n          })),\n        },\n        calculations: {\n          material: {\n            totalCost: result.costs.material.totalCost,\n            totalArea: result.costs.material.totalArea,\n            totalQuantity: result.costs.material.totalQuantity,\n            items: result.costs.material.items,\n          },\n          subtotal: result.financialSummary.subtotal,\n          finalPrice: result.financialSummary.finalPrice,\n        },\n        verification: {\n          expectedMaterialCost: components.length > 0 && components[0].materialType === 'ام دی اف' \n            ? (components[0].area * components[0].quantity * 125000).toLocaleString() + ' Rials'\n            : 'N/A',\n          note: 'For 333.csv.xlsx: Expected material cost = 0.36 m² × 125,000 = 45,000 Rials',\n        },\n      };\n    } catch (error) {\n      throw new HttpException(\n        {\n          message: 'Debug parsing failed',\n          error: error instanceof Error ? error.message : 'Unknown error',\n        },\n        HttpStatus.INTERNAL_SERVER_ERROR\n      );\n    }\n  }\n\n  /**\n   * Health check endpoint\n   * GET /api/v1/calculate/health\n   */\n  @Get('health')\n  @ApiOperation({ summary: 'Health check' })\n  @ApiResponse({ status: 200, description: 'Service is healthy' })\n  async health(): Promise<{ status: string; version: string }> {\n    return {\n      status: 'ok',\n      version: '1.0.0',\n    };\n  }\n}\n\n"],"names":["CostCalculationController","calculateFullCost","dto","validation","validateComponents","components","isValid","HttpException","message","errors","warnings","HttpStatus","BAD_REQUEST","result","costCalculationService","projectData","error","Error","INTERNAL_SERVER_ERROR","validateCSV","file","stream","Readable","from","buffer","csv","require","rows","headers","Promise","resolve","reject","pipe","on","hdrs","row","push","length","headerValidation","validateHeaders","isLexaCutFormat","some","h","toLowerCase","format","includes","validComponents","stream2","parseCSV","parseError","missingColumns","join","extraColumns","foundColumns","rowCount","undefined","calculateDirect","parts","map","part","name","componentId","number","quantity","count","edge1","edge_ymin","edge2","edge_ymax","edge3","edge_xmin","edge4","edge_xmax","materialType","material_name","instanceType","entity_names","cutting_length","width","cutting_width","area","final_area","console","calculateFromCSV","projectDataJson","JSON","parse","fileContent","toString","firstLines","split","slice","filePreview","fileSize","size","log","stringify","csvPreview","hint","costs","material","totalCost","SyntaxError","getPricingConfig","overhead1","overhead2","overhead3","overhead4","contingency","profitMargin","debugParse","client","date","Date","toISOString","fileInfo","originalName","originalname","mimetype","isExcel","parsed","componentCount","comp","edges","calculations","totalArea","totalQuantity","items","subtotal","financialSummary","finalPrice","verification","expectedMaterialCost","toLocaleString","note","health","status","version","summary","description"],"mappings":";;;;+BA+BaA;;;eAAAA;;;wBAtBN;iCACyB;yBACgC;wBACvC;wCACc;gCAOhC;+BACsC;qCACb;;;;;;;;;;;;;;;AASzB,IAAA,AAAMA,4BAAN,MAAMA;IAKX;;;GAGC,GACD,MAOMC,kBACJ,AAAQC,GAAyB,EACL;QAC5B,IAAI;YACF,sBAAsB;YACtB,MAAMC,aAAaC,IAAAA,iCAAkB,EAACF,IAAIG,UAAU;YACpD,IAAI,CAACF,WAAWG,OAAO,EAAE;gBACvB,MAAM,IAAIC,qBAAa,CACrB;oBACEC,SAAS;oBACTC,QAAQN,WAAWM,MAAM;oBACzBC,UAAUP,WAAWO,QAAQ;gBAC/B,GACAC,kBAAU,CAACC,WAAW;YAE1B;YAEA,YAAY;YACZ,MAAMC,SAAS,MAAM,IAAI,CAACC,sBAAsB,CAACb,iBAAiB,CAChEC,IAAIG,UAAU,EACdH,IAAIa,WAAW;YAGjB,OAAOF;QACT,EAAE,OAAOG,OAAO;YACd,IAAIA,iBAAiBT,qBAAa,EAAE;gBAClC,MAAMS;YACR;YACA,MAAM,IAAIT,qBAAa,CACrB;gBACEC,SAAS;gBACTQ,OAAOA,iBAAiBC,QAAQD,MAAMR,OAAO,GAAG;YAClD,GACAG,kBAAU,CAACO,qBAAqB;QAEpC;IACF;IAEA;;;GAGC,GACD,MASMC,YACJ,AAAgBC,IAAS,EAYxB;QACD,IAAI,CAACA,MAAM;YACT,MAAM,IAAIb,qBAAa,CAAC,oBAAoBI,kBAAU,CAACC,WAAW;QACpE;QAEA,IAAI;YACF,+CAA+C;YAC/C,MAAMS,SAASC,gBAAQ,CAACC,IAAI,CAACH,KAAKI,MAAM;YACxC,MAAMC,MAAMC,QAAQ;YACpB,MAAMC,OAAc,EAAE;YACtB,IAAIC,UAAoB,EAAE;YAE1B,MAAM,IAAIC,QAAQ,CAACC,SAASC;gBAC1BV,OACGW,IAAI,CAACP,OACLQ,EAAE,CAAC,WAAW,CAACC;oBACdN,UAAUM;gBACZ,GACCD,EAAE,CAAC,QAAQ,CAACE;oBACXR,KAAKS,IAAI,CAACD;oBACV,6CAA6C;oBAC7C,IAAIR,KAAKU,MAAM,IAAI,KAAK;wBACtBP,QAAQH;oBACV;gBACF,GACCM,EAAE,CAAC,OAAO,IAAMH,QAAQH,OACxBM,EAAE,CAAC,SAASF;YACjB;YAEA,0CAA0C;YAC1C,MAAMO,mBAAmBC,IAAAA,oCAAe,EAACX;YAEzC,mBAAmB;YACnB,MAAMY,kBAAkBZ,QAAQa,IAAI,CAACC,CAAAA,IAAKA,EAAEC,WAAW,OAAO;YAC9D,MAAMC,SAASJ,kBAAkB,YAClBZ,QAAQa,IAAI,CAACC,CAAAA,IAAKA,EAAEC,WAAW,GAAGE,QAAQ,CAAC,mBAAmB,WAC9D;YAEf,oDAAoD;YACpD,IAAIC,kBAAkB;YACtB,MAAMrC,SAAmB,EAAE;YAC3B,MAAMC,WAAqB,EAAE;YAE7B,IAAI;gBACF,MAAMqC,UAAUzB,gBAAQ,CAACC,IAAI,CAACH,KAAKI,MAAM;gBACzC,MAAMnB,aAAa,MAAM2C,IAAAA,uBAAQ,EAACD;gBAClCD,kBAAkBzC,WAAWgC,MAAM;gBAEnC,IAAIS,oBAAoB,GAAG;oBACzBrC,OAAO2B,IAAI,CAAC;gBACd,OAAO,IAAIU,kBAAkBnB,KAAKU,MAAM,GAAG,KAAK;oBAC9C3B,SAAS0B,IAAI,CAAC,CAAC,KAAK,EAAEU,gBAAgB,QAAQ,EAAEnB,KAAKU,MAAM,CAAC,yCAAyC,CAAC;gBACxG;YACF,EAAE,OAAOY,YAAiB;gBACxBxC,OAAO2B,IAAI,CAAC,CAAC,eAAe,EAAEa,WAAWzC,OAAO,EAAE;YACpD;YAEA,4CAA4C;YAC5C,IAAI,CAAC8B,iBAAiBhC,OAAO,IAAIgC,iBAAiBY,cAAc,CAACb,MAAM,GAAG,GAAG;gBAC3E3B,SAAS0B,IAAI,CAAC,CAAC,6BAA6B,EAAEE,iBAAiBY,cAAc,CAACC,IAAI,CAAC,OAAO;YAC5F;YAEA,OAAO;gBACL7C,SAASgC,iBAAiBhC,OAAO,IAAIwC,kBAAkB;gBACvDF;gBACAhB;gBACAsB,gBAAgBZ,iBAAiBY,cAAc;gBAC/CE,cAAcd,iBAAiBc,YAAY;gBAC3CC,cAAcf,iBAAiBe,YAAY;gBAC3CC,UAAU3B,KAAKU,MAAM;gBACrBS;gBACArC,QAAQA,OAAO4B,MAAM,GAAG,IAAI5B,SAAS8C;gBACrC7C,UAAUA,SAAS2B,MAAM,GAAG,IAAI3B,WAAW6C;YAC7C;QACF,EAAE,OAAOvC,OAAY;YACnB,MAAM,IAAIT,qBAAa,CACrB;gBACEC,SAAS;gBACTQ,OAAOA,iBAAiBC,QAAQD,MAAMR,OAAO,GAAG;YAClD,GACAG,kBAAU,CAACC,WAAW;QAE1B;IACF;IAEA;;;GAGC,GACD,MAOM4C,gBACJ,AAAQtD,GAAyB,EACL;QAC5B,IAAI;YACF,kDAAkD;YAClD,MAAMG,aAA8BH,IAAIuD,KAAK,CAACC,GAAG,CAACC,CAAAA,OAAS,CAAA;oBACzDC,MAAMD,KAAKC,IAAI;oBACfC,aAAaF,KAAKG,MAAM;oBACxBC,UAAUJ,KAAKK,KAAK;oBACpBC,OAAON,KAAKO,SAAS,IAAI;oBACzBC,OAAOR,KAAKS,SAAS,IAAI;oBACzBC,OAAOV,KAAKW,SAAS,IAAI;oBACzBC,OAAOZ,KAAKa,SAAS,IAAI;oBACzBC,cAAcd,KAAKe,aAAa;oBAChCC,cAAchB,KAAKiB,YAAY;oBAC/BvC,QAAQsB,KAAKkB,cAAc;oBAC3BC,OAAOnB,KAAKoB,aAAa;oBACzBC,MAAMrB,KAAKsB,UAAU;gBACvB,CAAA;YAEA,sBAAsB;YACtB,MAAM9E,aAAaC,IAAAA,iCAAkB,EAACC;YACtC,IAAI,CAACF,WAAWG,OAAO,EAAE;gBACvB,MAAM,IAAIC,qBAAa,CACrB;oBACEC,SAAS;oBACTC,QAAQN,WAAWM,MAAM;gBAC3B,GACAE,kBAAU,CAACC,WAAW;YAE1B;YAEA,8BAA8B;YAC9B,MAAMC,SAAS,MAAM,IAAI,CAACC,sBAAsB,CAACb,iBAAiB,CAChEI,YACAH,IAAIa,WAAW;YAGjB,OAAOF;QACT,EAAE,OAAOG,OAAY;YACnBkE,QAAQlE,KAAK,CAAC,6BAA6BA;YAC3C,MAAM,IAAIT,qBAAa,CACrB;gBACEC,SAAS;gBACTQ,OAAOA,iBAAiBC,QAAQD,MAAMR,OAAO,GAAG;YAClD,GACAG,kBAAU,CAACO,qBAAqB;QAEpC;IACF;IAEA;;;GAGC,GACD,MASMiE,iBACJ,AAAgB/D,IAAS,EACzB,AAAqBgE,eAAuB,EAChB;QAC5B,IAAI,CAAChE,MAAM;YACT,MAAM,IAAIb,qBAAa,CAAC,oBAAoBI,kBAAU,CAACC,WAAW;QACpE;QAEA,IAAI;YACF,sCAAsC;YACtC,MAAMG,cAA8BsE,KAAKC,KAAK,CAACF;YAE/C,YAAY;YACZ,MAAM/D,SAASC,gBAAQ,CAACC,IAAI,CAACH,KAAKI,MAAM;YACxC,IAAInB;YAEJ,IAAI;gBACFA,aAAa,MAAM2C,IAAAA,uBAAQ,EAAC3B;YAC9B,EAAE,OAAOL,OAAO;gBACd,4DAA4D;gBAC5D,MAAMuE,cAAcnE,KAAKI,MAAM,CAACgE,QAAQ,CAAC;gBACzC,MAAMC,aAAaF,YAAYG,KAAK,CAAC,MAAMC,KAAK,CAAC,GAAG,GAAGxC,IAAI,CAAC;gBAE5D,MAAM,IAAI5C,qBAAa,CACrB;oBACEC,SAAS;oBACTQ,OAAOA,iBAAiBC,QAAQD,MAAMR,OAAO,GAAG;oBAChDoF,aAAaH;oBACbI,UAAUzE,KAAK0E,IAAI;gBACrB,GACAnF,kBAAU,CAACC,WAAW;YAE1B;YAEA,gBAAgB;YAChBsE,QAAQa,GAAG,CAAC,CAAC,OAAO,EAAE1F,WAAWgC,MAAM,CAAC,oBAAoB,CAAC;YAC7D,IAAIhC,WAAWgC,MAAM,GAAG,GAAG;gBACzB6C,QAAQa,GAAG,CAAC,oBAAoBV,KAAKW,SAAS,CAAC3F,UAAU,CAAC,EAAE,EAAE,MAAM;YACtE,OAAO;gBACL,uDAAuD;gBACvD,MAAMkF,cAAcnE,KAAKI,MAAM,CAACgE,QAAQ,CAAC;gBACzC,MAAMC,aAAaF,YAAYG,KAAK,CAAC,MAAMC,KAAK,CAAC,GAAG,IAAIxC,IAAI,CAAC;gBAC7D+B,QAAQa,GAAG,CAAC,sCAAsCN;YACpD;YAEA,WAAW;YACX,MAAMtF,aAAaC,IAAAA,iCAAkB,EAACC;YACtC,IAAI,CAACF,WAAWG,OAAO,IAAID,WAAWgC,MAAM,KAAK,GAAG;gBAClD,6CAA6C;gBAC7C,MAAMkD,cAAcnE,KAAKI,MAAM,CAACgE,QAAQ,CAAC;gBACzC,MAAMC,aAAaF,YAAYG,KAAK,CAAC,MAAMC,KAAK,CAAC,GAAG,IAAIxC,IAAI,CAAC;gBAE7D,MAAM,IAAI5C,qBAAa,CACrB;oBACEC,SAAS;oBACTC,QAAQ;wBACN;2BACGN,WAAWM,MAAM,CAACkF,KAAK,CAAC,GAAG;qBAC/B;oBACDjF,UAAUP,WAAWO,QAAQ,CAACiF,KAAK,CAAC,GAAG;oBACvCM,YAAYR;oBACZS,MAAM;gBACR,GACAvF,kBAAU,CAACC,WAAW;YAE1B;YAEA,IAAI,CAACT,WAAWG,OAAO,EAAE;gBACvB,MAAM,IAAIC,qBAAa,CACrB;oBACEC,SAAS;oBACTC,QAAQN,WAAWM,MAAM;oBACzBC,UAAUP,WAAWO,QAAQ;gBAC/B,GACAC,kBAAU,CAACC,WAAW;YAE1B;YAEA,IAAIP,WAAWgC,MAAM,KAAK,GAAG;gBAC3B,MAAM,IAAI9B,qBAAa,CACrB;oBACEC,SAAS;oBACTC,QAAQ;wBAAC;qBAA8D;gBACzE,GACAE,kBAAU,CAACC,WAAW;YAE1B;YAEA,YAAY;YACZ,MAAMC,SAAS,MAAM,IAAI,CAACC,sBAAsB,CAACb,iBAAiB,CAChEI,YACAU;YAGF,gBAAgB;YAChBmE,QAAQa,GAAG,CAAC,CAAC,qCAAqC,EAAElF,OAAOsF,KAAK,CAACC,QAAQ,CAACC,SAAS,EAAE;YAErF,OAAOxF;QACT,EAAE,OAAOG,OAAO;YACd,IAAIA,iBAAiBT,qBAAa,EAAE;gBAClC,MAAMS;YACR;YACA,IAAIA,iBAAiBsF,aAAa;gBAChC,MAAM,IAAI/F,qBAAa,CACrB,6BACAI,kBAAU,CAACC,WAAW;YAE1B;YACA,MAAM,IAAIL,qBAAa,CACrB;gBACEC,SAAS;gBACTQ,OAAOA,iBAAiBC,QAAQD,MAAMR,OAAO,GAAG;YAClD,GACAG,kBAAU,CAACO,qBAAqB;QAEpC;IACF;IAEA;;;GAGC,GACD,MAGMqF,mBAA8C;QAClD,sCAAsC;QACtC,OAAO;YACLC,WAAW;YACXC,WAAW;YACXC,WAAW;YACXC,WAAW;YACXC,aAAa;YACbC,cAAc;QAChB;IACF;IAEA;;;GAGC,GACD,MAKMC,WACJ,AAAgB1F,IAAS,EACX;QACd,IAAI,CAACA,MAAM;YACT,MAAM,IAAIb,qBAAa,CAAC,oBAAoBI,kBAAU,CAACC,WAAW;QACpE;QAEA,IAAI;YACF,MAAMS,SAASC,gBAAQ,CAACC,IAAI,CAACH,KAAKI,MAAM;YACxC,MAAMnB,aAAa,MAAM2C,IAAAA,uBAAQ,EAAC3B;YAElC,0CAA0C;YAC1C,MAAMN,cAA8B;gBAClC6C,MAAM;gBACNmD,QAAQ;gBACRC,MAAM,IAAIC,OAAOC,WAAW,GAAGxB,KAAK,CAAC,IAAI,CAAC,EAAE;YAC9C;YAEA,MAAM7E,SAAS,MAAM,IAAI,CAACC,sBAAsB,CAACb,iBAAiB,CAChEI,YACAU;YAGF,OAAO;gBACLoG,UAAU;oBACRC,cAAchG,KAAKiG,YAAY;oBAC/BvB,MAAM1E,KAAK0E,IAAI;oBACfwB,UAAUlG,KAAKkG,QAAQ;oBACvBC,SAASnG,KAAKI,MAAM,CAAC,EAAE,KAAK,QAAQJ,KAAKI,MAAM,CAAC,EAAE,KAAK;gBACzD;gBACAgG,QAAQ;oBACNC,gBAAgBpH,WAAWgC,MAAM;oBACjChC,YAAYA,WAAWqD,GAAG,CAACgE,CAAAA,OAAS,CAAA;4BAClC9D,MAAM8D,KAAK9D,IAAI;4BACfC,aAAa6D,KAAK7D,WAAW;4BAC7BE,UAAU2D,KAAK3D,QAAQ;4BACvB1B,QAAQqF,KAAKrF,MAAM;4BACnByC,OAAO4C,KAAK5C,KAAK;4BACjBE,MAAM0C,KAAK1C,IAAI;4BACfP,cAAciD,KAAKjD,YAAY;4BAC/BE,cAAc+C,KAAK/C,YAAY;4BAC/BgD,OAAO;gCACL1D,OAAOyD,KAAKzD,KAAK;gCACjBE,OAAOuD,KAAKvD,KAAK;gCACjBE,OAAOqD,KAAKrD,KAAK;gCACjBE,OAAOmD,KAAKnD,KAAK;4BACnB;wBACF,CAAA;gBACF;gBACAqD,cAAc;oBACZxB,UAAU;wBACRC,WAAWxF,OAAOsF,KAAK,CAACC,QAAQ,CAACC,SAAS;wBAC1CwB,WAAWhH,OAAOsF,KAAK,CAACC,QAAQ,CAACyB,SAAS;wBAC1CC,eAAejH,OAAOsF,KAAK,CAACC,QAAQ,CAAC0B,aAAa;wBAClDC,OAAOlH,OAAOsF,KAAK,CAACC,QAAQ,CAAC2B,KAAK;oBACpC;oBACAC,UAAUnH,OAAOoH,gBAAgB,CAACD,QAAQ;oBAC1CE,YAAYrH,OAAOoH,gBAAgB,CAACC,UAAU;gBAChD;gBACAC,cAAc;oBACZC,sBAAsB/H,WAAWgC,MAAM,GAAG,KAAKhC,UAAU,CAAC,EAAE,CAACoE,YAAY,KAAK,aAC1E,AAACpE,CAAAA,UAAU,CAAC,EAAE,CAAC2E,IAAI,GAAG3E,UAAU,CAAC,EAAE,CAAC0D,QAAQ,GAAG,MAAK,EAAGsE,cAAc,KAAK,WAC1E;oBACJC,MAAM;gBACR;YACF;QACF,EAAE,OAAOtH,OAAO;YACd,MAAM,IAAIT,qBAAa,CACrB;gBACEC,SAAS;gBACTQ,OAAOA,iBAAiBC,QAAQD,MAAMR,OAAO,GAAG;YAClD,GACAG,kBAAU,CAACO,qBAAqB;QAEpC;IACF;IAEA;;;GAGC,GACD,MAGMqH,SAAuD;QAC3D,OAAO;YACLC,QAAQ;YACRC,SAAS;QACX;IACF;IA1dA,YACE,AAAiB3H,sBAA8C,CAC/D;aADiBA,yBAAAA;IAChB;AAydL;;;;QAldkB4H,SAAS;;;QAEvBF,QAAQ;QACRG,aAAa;;;QAEAH,QAAQ;QAAKG,aAAa;;;;;;;;;;;;;QA6CzBD,SAAS;;;;QAGvBF,QAAQ;QACRG,aAAa;;;QAEAH,QAAQ;QAAKG,aAAa;;;;;;;;;;;;QAwGzBD,SAAS;;;QAEvBF,QAAQ;QACRG,aAAa;;;QAEAH,QAAQ;QAAKG,aAAa;;;;;;;;;;;;;QA0DzBD,SAAS;;;;QAGvBF,QAAQ;QACRG,aAAa;;;QAEAH,QAAQ;QAAKG,aAAa;;;;;;;;;;;;;;QA4HzBD,SAAS;;;QACVF,QAAQ;QAAKG,aAAa;;;;;;;;;;QAmBzBD,SAAS;;;;QAEVF,QAAQ;QAAKG,aAAa;;;;;;;;;;;;QAmFzBD,SAAS;;;QACVF,QAAQ;QAAKG,aAAa"}