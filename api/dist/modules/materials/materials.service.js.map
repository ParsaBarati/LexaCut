{"version":3,"sources":["../../../src/modules/materials/materials.service.ts"],"sourcesContent":["import { Injectable } from '@nestjs/common';\nimport {\n  ProcessedComponent,\n  MaterialCategory,\n  CostItem,\n} from '../../common/interfaces';\nimport { PricingLookupService } from '../../common/utils/pricing-lookup.service';\nimport { sum, round } from '../../common/utils/excel-functions';\n\n/**\n * Material Service\n * Implements calculations from \"Material\" sheet\n * Processes material costs from component data using Pivot Table logic\n */\n@Injectable()\nexport class MaterialsService {\n  constructor(private readonly pricingLookup: PricingLookupService) {}\n\n  /**\n   * Calculate material costs from processed components\n   * Replicates VBA Material() macro and Material sheet calculations\n   * \n   * Excel flow:\n   * 1. Creates Pivot Table from \"All\" sheet (W:X range)\n   * 2. Groups by Material, sums SumArea\n   * 3. Copies pivot results to Material sheet (AA4:AB27 → I7:H7)\n   * 4. VLOOKUPs material descriptions and units (W:Z range)\n   * 5. Calculates costs and sums to A31\n   * \n   * @param components - Processed components with material data\n   * @returns MaterialCategory with calculated costs\n   */\n  async calculateMaterialCosts(components: ProcessedComponent[]): Promise<MaterialCategory> {\n    console.log(`MaterialsService: Calculating costs for ${components.length} components`);\n    \n    // Step 1: Group components by material type (Pivot Table equivalent)\n    // Excel: Pivot Table on All sheet W:X, grouped by Material\n    const materialGroups = this.groupByMaterial(components);\n    \n    console.log(`MaterialsService: Found ${Object.keys(materialGroups).length} material groups:`, Object.keys(materialGroups));\n\n    // Step 2: Calculate cost for each material group\n    const items: CostItem[] = [];\n    let totalCost = 0;\n    let totalArea = 0;\n    let totalQuantity = 0;\n\n    for (const [materialType, groupData] of Object.entries(materialGroups)) {\n      console.log(`MaterialsService: Processing material \"${materialType}\" with area ${groupData.totalArea}m²`);\n      // VLOOKUP material info from pricing tables (W:Z range)\n      // Try by name first (handles Persian names), then by code\n      const materialInfo = await this.pricingLookup.getMaterialByName(materialType) || \n                          await this.pricingLookup.getMaterialByCode(materialType);\n      \n      if (!materialInfo) {\n        // If material not found in pricing table, use default pricing\n        console.warn(`Material not found in pricing table: ${materialType}, using default`);\n        // Use default MDF pricing as fallback\n        const allMaterials = await this.pricingLookup.getAllMaterials();\n        const defaultMaterial = allMaterials[0];\n        if (!defaultMaterial) {\n          console.error('No materials in pricing table!');\n          continue;\n        }\n        // Continue with default material\n        const cost = round(groupData.totalArea * (defaultMaterial.unitPrice || 125000), 0);\n        items.push({\n          cost,\n          description: materialType || defaultMaterial.description,\n          unit: defaultMaterial.unit || 'm²',\n          quantity: groupData.totalArea,\n          code: materialType,\n        });\n        totalCost += cost;\n        totalArea += groupData.totalArea;\n        totalQuantity += groupData.count;\n        continue;\n      }\n\n      // Calculate total area for this material (SumArea from pivot)\n      const groupArea = groupData.totalArea;\n      \n      // Calculate cost = area * unit price\n      // Excel: Material sheet, Column A (cost calculations)\n      const cost = round(groupArea * (materialInfo.unitPrice || 0), 0);\n\n      items.push({\n        cost,                                   // Column A\n        description: materialInfo.description,  // Column B (from VLOOKUP)\n        unit: materialInfo.unit,                // Column C (from VLOOKUP)\n        quantity: groupArea,                    // Column D (area in m²)\n        code: materialType,                     // Column I (material code)\n      });\n\n      totalCost += cost;\n      totalArea += groupArea;\n      totalQuantity += groupData.count;\n    }\n\n    // Sum totals (Material!A31, C31, E31, G31)\n    return {\n      category: 'Material',\n      totalCost: round(totalCost, 0),        // Material!A31 = SUM(A7:A30)\n      totalArea: round(totalArea, 2),        // Material!C31 = SUM(C7:C30) if present\n      totalQuantity: round(totalQuantity, 0), // Material!E31 = SUM(E7:E30) if present\n      items,\n    };\n  }\n\n  /**\n   * Group components by material type and sum areas\n   * Replicates Excel Pivot Table: PivotFields(\"Material\").Orientation = xlRowField\n   * \n   * @param components - Array of processed components\n   * @returns Map of material type to aggregated data\n   */\n  private groupByMaterial(components: ProcessedComponent[]): Record<string, {\n    totalArea: number;\n    count: number;\n    components: ProcessedComponent[];\n  }> {\n    const groups: Record<string, {\n      totalArea: number;\n      count: number;\n      components: ProcessedComponent[];\n    }> = {};\n\n    for (const component of components) {\n      const materialKey = component.materialType;\n      \n      if (!groups[materialKey]) {\n        groups[materialKey] = {\n          totalArea: 0,\n          count: 0,\n          components: [],\n        };\n      }\n\n      // Sum area (SumArea field in pivot table)\n      // Excel: .PivotFields(\"SumArea\").Orientation = xlDataField\n      groups[materialKey].totalArea += component.sumArea || component.area;\n      groups[materialKey].count += 1;\n      groups[materialKey].components.push(component);\n    }\n\n    return groups;\n  }\n\n  /**\n   * Calculate material requirements with waste percentage\n   * Applies waste multiplier from Data!E2\n   * \n   * @param materialCosts - Base material costs\n   * @param wastePercentage - Waste percentage (e.g., 0.15 for 15%)\n   * @returns Adjusted material costs with waste included\n   */\n  applyWastePercentage(\n    materialCosts: MaterialCategory,\n    wastePercentage: number\n  ): MaterialCategory {\n    const wasteMultiplier = 1 + wastePercentage;\n    \n    return {\n      ...materialCosts,\n      totalCost: round(materialCosts.totalCost * wasteMultiplier, 0),\n      totalArea: materialCosts.totalArea \n        ? round(materialCosts.totalArea * wasteMultiplier, 2)\n        : undefined,\n      items: materialCosts.items.map(item => ({\n        ...item,\n        cost: round(item.cost * wasteMultiplier, 0),\n        quantity: round(item.quantity * wasteMultiplier, 2),\n      })),\n    };\n  }\n\n  /**\n   * Get material summary statistics\n   * Useful for reporting and validation\n   */\n  getMaterialSummary(materialCosts: MaterialCategory): {\n    totalMaterials: number;\n    averageCostPerItem: number;\n    totalArea: number;\n    mostExpensiveMaterial: string;\n  } {\n    const items = materialCosts.items;\n    const totalMaterials = items.length;\n    const averageCostPerItem = totalMaterials > 0 \n      ? materialCosts.totalCost / totalMaterials \n      : 0;\n    \n    const mostExpensive = items.reduce((max, item) => \n      item.cost > max.cost ? item : max, \n      items[0] || { cost: 0, description: '' }\n    );\n\n    return {\n      totalMaterials,\n      averageCostPerItem: round(averageCostPerItem, 0),\n      totalArea: materialCosts.totalArea || 0,\n      mostExpensiveMaterial: mostExpensive.description,\n    };\n  }\n\n  /**\n   * Validate material costs against expected ranges\n   * Helps catch calculation errors\n   */\n  validateMaterialCosts(materialCosts: MaterialCategory): {\n    isValid: boolean;\n    warnings: string[];\n  } {\n    const warnings: string[] = [];\n\n    // Check for zero or negative costs\n    if (materialCosts.totalCost <= 0) {\n      warnings.push('Total material cost is zero or negative');\n    }\n\n    // Check for items with zero cost\n    materialCosts.items.forEach((item, index) => {\n      if (item.cost <= 0) {\n        warnings.push(`Item ${index + 1} (${item.description}) has zero or negative cost`);\n      }\n      \n      if (item.quantity <= 0) {\n        warnings.push(`Item ${index + 1} (${item.description}) has zero or negative quantity`);\n      }\n    });\n\n    return {\n      isValid: warnings.length === 0,\n      warnings,\n    };\n  }\n}\n\n"],"names":["MaterialsService","calculateMaterialCosts","components","console","log","length","materialGroups","groupByMaterial","Object","keys","items","totalCost","totalArea","totalQuantity","materialType","groupData","entries","materialInfo","pricingLookup","getMaterialByName","getMaterialByCode","warn","allMaterials","getAllMaterials","defaultMaterial","error","cost","round","unitPrice","push","description","unit","quantity","code","count","groupArea","category","groups","component","materialKey","sumArea","area","applyWastePercentage","materialCosts","wastePercentage","wasteMultiplier","undefined","map","item","getMaterialSummary","totalMaterials","averageCostPerItem","mostExpensive","reduce","max","mostExpensiveMaterial","validateMaterialCosts","warnings","forEach","index","isValid"],"mappings":"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"}