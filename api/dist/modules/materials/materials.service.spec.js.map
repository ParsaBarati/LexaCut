{"version":3,"sources":["../../../src/modules/materials/materials.service.spec.ts"],"sourcesContent":["import { Test, TestingModule } from '@nestjs/testing';\nimport { MaterialsService } from './materials.service';\nimport { PricingLookupService } from '../../common/utils/pricing-lookup.service';\nimport { ProcessedComponent } from '../../common/interfaces';\nimport {\n  processedDoorComponent,\n  processedCNCComponent,\n  processedComponentSet,\n} from '../../test/fixtures/test-components.fixture';\n\ndescribe('MaterialsService', () => {\n  let service: MaterialsService;\n  let pricingLookupService: jest.Mocked<PricingLookupService>;\n\n  beforeEach(async () => {\n    // Create mock pricing lookup service\n    const mockPricingLookupService = {\n      getMaterialByName: jest.fn(),\n      getMaterialByCode: jest.fn(),\n      getAllMaterials: jest.fn(),\n    };\n\n    const module: TestingModule = await Test.createTestingModule({\n      providers: [\n        MaterialsService,\n        {\n          provide: PricingLookupService,\n          useValue: mockPricingLookupService,\n        },\n      ],\n    }).compile();\n\n    service = module.get<MaterialsService>(MaterialsService);\n    pricingLookupService = module.get(PricingLookupService);\n  });\n\n  it('should be defined', () => {\n    expect(service).toBeDefined();\n  });\n\n  describe('calculateMaterialCosts', () => {\n    it('should calculate costs for single material type', async () => {\n      // Setup mock material data\n      pricingLookupService.getMaterialByName.mockResolvedValue({\n        code: 'MAT-1',\n        description: 'ام دی اف 16 میل - سفید',\n        unit: 'متر مربع',\n        unitPrice: 22000000,\n        category: 'Panel',\n        persianNames: ['ام دی اف'],\n        isActive: true,\n        id: '1',\n        createdAt: new Date(),\n        updatedAt: new Date(),\n      });\n\n      const components: ProcessedComponent[] = [processedDoorComponent];\n      const result = await service.calculateMaterialCosts(components);\n\n      expect(result).toBeDefined();\n      expect(result.category).toBe('Material');\n      expect(result.totalCost).toBeGreaterThan(0);\n      expect(result.totalArea).toBeCloseTo(0.48, 2);\n      expect(result.items).toHaveLength(1);\n      expect(result.items[0].description).toBe('ام دی اف 16 میل - سفید');\n    });\n\n    it('should calculate costs for multiple material types', async () => {\n      // Setup different materials\n      pricingLookupService.getMaterialByName\n        .mockResolvedValueOnce({\n          code: 'MAT-1',\n          description: 'ام دی اف 16 میل - سفید',\n          unit: 'متر مربع',\n          unitPrice: 22000000,\n          category: 'Panel',\n          persianNames: ['ام دی اف'],\n          isActive: true,\n          id: '1',\n          createdAt: new Date(),\n          updatedAt: new Date(),\n        })\n        .mockResolvedValueOnce({\n          code: 'MAT-4',\n          description: 'پی وی سی 16 میل - سفید',\n          unit: 'متر مربع',\n          unitPrice: 17000000,\n          category: 'Panel',\n          persianNames: ['پی وی سی'],\n          isActive: true,\n          id: '4',\n          createdAt: new Date(),\n          updatedAt: new Date(),\n        });\n\n      const components: ProcessedComponent[] = [\n        { ...processedDoorComponent, materialType: 'ام دی اف' },\n        { ...processedCNCComponent, materialType: 'پی وی سی' },\n      ];\n\n      const result = await service.calculateMaterialCosts(components);\n\n      expect(result.items.length).toBeGreaterThanOrEqual(1);\n      expect(result.totalCost).toBeGreaterThan(0);\n    });\n\n    it('should handle unknown materials with default pricing', async () => {\n      // Mock material not found, then return default\n      pricingLookupService.getMaterialByName.mockResolvedValue(undefined);\n      pricingLookupService.getMaterialByCode.mockResolvedValue(undefined);\n      pricingLookupService.getAllMaterials.mockResolvedValue([\n        {\n          code: 'MAT-1',\n          description: 'ام دی اف 16 میل - سفید',\n          unit: 'متر مربع',\n          unitPrice: 22000000,\n          category: 'Panel',\n          persianNames: ['ام دی اف'],\n          isActive: true,\n          id: '1',\n          createdAt: new Date(),\n          updatedAt: new Date(),\n        },\n      ]);\n\n      const components: ProcessedComponent[] = [\n        { ...processedDoorComponent, materialType: 'Unknown Material XYZ' },\n      ];\n\n      const result = await service.calculateMaterialCosts(components);\n\n      expect(result.totalCost).toBeGreaterThan(0);\n      expect(result.items).toHaveLength(1);\n      // Should use default material\n      expect(pricingLookupService.getAllMaterials).toHaveBeenCalled();\n    });\n\n    it('should group components by material type', async () => {\n      pricingLookupService.getMaterialByName.mockResolvedValue({\n        code: 'MAT-1',\n        description: 'ام دی اف 16 میل - سفید',\n        unit: 'متر مربع',\n        unitPrice: 22000000,\n        category: 'Panel',\n        persianNames: ['ام دی اف'],\n        isActive: true,\n        id: '1',\n        createdAt: new Date(),\n        updatedAt: new Date(),\n      });\n\n      // Multiple components with same material\n      const components: ProcessedComponent[] = [\n        { ...processedDoorComponent, sumArea: 0.48 },\n        { ...processedCNCComponent, materialType: 'ام دی اف', sumArea: 0.48 },\n      ];\n\n      const result = await service.calculateMaterialCosts(components);\n\n      // Should have 1 material group with combined area\n      expect(result.items).toHaveLength(1);\n      expect(result.totalArea).toBeCloseTo(0.96, 2);\n    });\n  });\n\n  describe('applyWastePercentage', () => {\n    it('should apply waste percentage correctly', () => {\n      const baseCosts = {\n        category: 'Material' as const,\n        totalCost: 1000000,\n        totalArea: 1.0,\n        totalQuantity: 10,\n        items: [\n          {\n            cost: 1000000,\n            description: 'Test Material',\n            unit: 'm²',\n            quantity: 1.0,\n            code: 'TEST',\n          },\n        ],\n      };\n\n      const result = service.applyWastePercentage(baseCosts, 0.15);\n\n      expect(result.totalCost).toBe(1150000); // 1M × 1.15\n      expect(result.totalArea).toBeCloseTo(1.15, 2);\n      expect(result.items[0].cost).toBe(1150000);\n      expect(result.items[0].quantity).toBeCloseTo(1.15, 2);\n    });\n\n    it('should handle zero waste percentage', () => {\n      const baseCosts = {\n        category: 'Material' as const,\n        totalCost: 1000000,\n        totalArea: 1.0,\n        totalQuantity: 10,\n        items: [],\n      };\n\n      const result = service.applyWastePercentage(baseCosts, 0);\n\n      expect(result.totalCost).toBe(1000000);\n      expect(result.totalArea).toBe(1.0);\n    });\n  });\n\n  describe('getMaterialSummary', () => {\n    it('should return correct summary statistics', () => {\n      const materialCosts = {\n        category: 'Material' as const,\n        totalCost: 5000000,\n        totalArea: 2.5,\n        totalQuantity: 10,\n        items: [\n          {\n            cost: 3000000,\n            description: 'Material A',\n            unit: 'm²',\n            quantity: 1.5,\n            code: 'MAT-A',\n          },\n          {\n            cost: 2000000,\n            description: 'Material B',\n            unit: 'm²',\n            quantity: 1.0,\n            code: 'MAT-B',\n          },\n        ],\n      };\n\n      const summary = service.getMaterialSummary(materialCosts);\n\n      expect(summary.totalMaterials).toBe(2);\n      expect(summary.averageCostPerItem).toBe(2500000);\n      expect(summary.totalArea).toBe(2.5);\n      expect(summary.mostExpensiveMaterial).toBe('Material A');\n    });\n  });\n\n  describe('validateMaterialCosts', () => {\n    it('should validate costs without warnings', () => {\n      const materialCosts = {\n        category: 'Material' as const,\n        totalCost: 5000000,\n        totalArea: 2.5,\n        totalQuantity: 10,\n        items: [\n          {\n            cost: 5000000,\n            description: 'Material A',\n            unit: 'm²',\n            quantity: 2.5,\n            code: 'MAT-A',\n          },\n        ],\n      };\n\n      const validation = service.validateMaterialCosts(materialCosts);\n\n      expect(validation.isValid).toBe(true);\n      expect(validation.warnings).toHaveLength(0);\n    });\n\n    it('should detect zero total cost', () => {\n      const materialCosts = {\n        category: 'Material' as const,\n        totalCost: 0,\n        totalArea: 2.5,\n        totalQuantity: 10,\n        items: [],\n      };\n\n      const validation = service.validateMaterialCosts(materialCosts);\n\n      expect(validation.isValid).toBe(false);\n      expect(validation.warnings.length).toBeGreaterThan(0);\n      expect(validation.warnings[0]).toContain('zero or negative');\n    });\n\n    it('should detect items with zero cost', () => {\n      const materialCosts = {\n        category: 'Material' as const,\n        totalCost: 5000000,\n        totalArea: 2.5,\n        totalQuantity: 10,\n        items: [\n          {\n            cost: 0,\n            description: 'Material A',\n            unit: 'm²',\n            quantity: 2.5,\n            code: 'MAT-A',\n          },\n        ],\n      };\n\n      const validation = service.validateMaterialCosts(materialCosts);\n\n      expect(validation.isValid).toBe(false);\n      expect(validation.warnings.length).toBeGreaterThan(0);\n    });\n  });\n});\n\n"],"names":["describe","service","pricingLookupService","beforeEach","mockPricingLookupService","getMaterialByName","jest","fn","getMaterialByCode","getAllMaterials","module","Test","createTestingModule","providers","MaterialsService","provide","PricingLookupService","useValue","compile","get","it","expect","toBeDefined","mockResolvedValue","code","description","unit","unitPrice","category","persianNames","isActive","id","createdAt","Date","updatedAt","components","processedDoorComponent","result","calculateMaterialCosts","toBe","totalCost","toBeGreaterThan","totalArea","toBeCloseTo","items","toHaveLength","mockResolvedValueOnce","materialType","processedCNCComponent","length","toBeGreaterThanOrEqual","undefined","toHaveBeenCalled","sumArea","baseCosts","totalQuantity","cost","quantity","applyWastePercentage","materialCosts","summary","getMaterialSummary","totalMaterials","averageCostPerItem","mostExpensiveMaterial","validation","validateMaterialCosts","isValid","warnings","toContain"],"mappings":"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"}